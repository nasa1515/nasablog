{"componentChunkName":"component---src-templates-blog-template-js","path":"/devops-gcpfilestore/","result":{"data":{"cur":{"id":"801845e2-ac0a-5de8-bf0a-12fd8d8036e2","html":"<p>머리말  </p>\n<p>이번 포스트에서는 앱 구동을 위한 MYSQL 이중화입니다 이전 포스트에서 앱 배포를 완료했지만<br>\nMYSQL pod의 경우 볼륨의 문제로 하나밖에 뜨지 않아 DB 데이터를 어떻게 저장할지에 대한 고민이 있었습니다.<br>\n고민해본 결과 NFS를 만들어서 그쪽에 데이터를 저장해놓고 POD가 실행될때마다 NFS를 읽어오자! 라는 결론이 나왔습니다<br>\n그래서 NFS 서버를 구축하려고 하려는 찰나 GCP에서 API 서비스로 제공한다는 소식을 듣고 바로 사용해 보았습니다</p>\n<hr>\n<ul>\n<li>\n<p>사용 할 툴을 다음과 같습니다.  </p>\n<ul>\n<li>GCP FileStore</li>\n<li>k8s PV,PVC</li>\n<li>ArgoCD</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h2 id=\"-발생-이슈\" style=\"position:relative;\"><a href=\"#-%EB%B0%9C%EC%83%9D-%EC%9D%B4%EC%8A%88\" aria-label=\" 발생 이슈 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>✔ 발생 이슈</h2>\n<ul>\n<li>\n<p>MYSQL Pod를 두개 이상 띄우려고 할때 아래와 같은 문제가 발생했다.  </p>\n<p><img src=\"https://user-images.githubusercontent.com/69498804/96840929-11b24100-1486-11eb-9157-145a7d03bf00.png\" alt=\"스크린샷, 2020-10-22 16-45-58\"></p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">FailedAttachVolume\nMulti<span class=\"token operator\">-</span>Attach error <span class=\"token keyword\">for</span> volume <span class=\"token string\">\"pvc-73526617-313f-46f4-be6f-0776dcf151d3\"</span> Volume <span class=\"token keyword\">is</span> <span class=\"token class-name\">already</span> used <span class=\"token keyword\">by</span> <span class=\"token function\">pod</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> mysql<span class=\"token operator\">-</span><span class=\"token number\">6749799856</span><span class=\"token operator\">-</span>kb9mp\t<span class=\"token number\">6</span> minutes ago</code></pre></div>\n</li>\n</ul>\n<br/>\n<ul>\n<li>\n<p>이유는 Google Persistent Disk의 경우 Block 스토리지의 Access Mode인 <code class=\"language-text\">ReadWriteMany</code> 옵션을 지원하지 않았습니다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/69498804/96841616-f6940100-1486-11eb-8b22-406d019bcf8b.png\" alt=\"스크린샷, 2020-10-22 16-52-21\"></p>\n<p>그래서 GKE를 만들때 자동 생성되는 스토리지 클래스를 사용하지 않고 PV를 직접 만들어 연결해줘야 하는 상황이 되었습니다</p>\n</li>\n</ul>\n<br/>\n<ul>\n<li>\n<p>다행히 공식문서를 보니 GCP에서 NFS(Filestore)를 PV로 지원한다는 문서를 확인해서 NFS를 사용하기로 했습니다</p>\n<p><img src=\"https://user-images.githubusercontent.com/69498804/96841887-4f639980-1487-11eb-9578-307b7b86267d.png\" alt=\"스크린샷, 2020-10-22 16-54-43\"></p>\n</li>\n</ul>\n<br/>\n<ul>\n<li>\n<p>GCP에서는 기본적으로 Standard 형의 스토리지 클래스를 지원합니다</p>\n<p><img src=\"https://user-images.githubusercontent.com/69498804/96842565-268fd400-1488-11eb-9d64-66a4b1fd41db.png\" alt=\"스크린샷, 2020-10-22 17-00-52\"></p>\n</li>\n</ul>\n<br/>\n<ul>\n<li>\n<p><a href=\"https://kubernetes.io/ko/docs/concepts/storage/storage-classes/\">쿠버네티스 공식문서</a></p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">스토리지클래스는 관리자가 제공하는 스토리지의 <span class=\"token string\">\"classes\"</span>를 설명할 수 있는 방법을 제공한다<span class=\"token punctuation\">.</span> \n다른 클래스는 서비스의 품질 수준 또는 백업 정책<span class=\"token punctuation\">,</span> 클러스터 관리자가 정한 임의의 정책에 매핑될 수 있다<span class=\"token punctuation\">.</span> \n쿠버네티스 자체는 클래스가 무엇을 나타내는지에 대해 상관하지 않는다<span class=\"token punctuation\">.</span> \n다른 스토리지 시스템에서는 이 개념을 <span class=\"token string\">\"프로파일\"</span>이라고도 한다<span class=\"token punctuation\">.</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">스토리지클래스 리소스 \n각 스토리지클래스에는 해당 스토리지클래스에 속하는 퍼시스턴트볼륨을 동적으로 프로비저닝 할 때 사용되는 provisioner<span class=\"token punctuation\">,</span> parameters 와 reclaimPolicy 필드가 포함된다<span class=\"token punctuation\">.</span>\n\n스토리지클래스 오브젝트의 이름은 중요하며<span class=\"token punctuation\">,</span> 사용자가 특정 클래스를 요청할 수 있는 방법이다<span class=\"token punctuation\">.</span> \n관리자는 스토리지클래스 오브젝트를 처음 생성할 때 클래스의 이름과 기타 파라미터를 설정하며<span class=\"token punctuation\">,</span> 일단 생성된 오브젝트는 업데이트할 수 없다<span class=\"token punctuation\">.</span>\n\n관리자는 특정 클래스에 바인딩을 요청하지 않는 PVC에 대해서만 기본 스토리지클래스를 지정할 수 있다<span class=\"token punctuation\">.</span> </code></pre></div>\n<br/>\n<ul>\n<li>쿠버네티스에서는 아래와 같이 정의 할 수 있다</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">apiVersion<span class=\"token punctuation\">:</span> storage<span class=\"token punctuation\">.</span>k8s<span class=\"token punctuation\">.</span>io<span class=\"token operator\">/</span><span class=\"token class-name\">v1</span>\nkind<span class=\"token punctuation\">:</span> <span class=\"token class-name\">StorageClass</span>\n  metadata<span class=\"token punctuation\">:</span>\n  name<span class=\"token punctuation\">:</span> <span class=\"token class-name\">standard</span>\n    provisioner<span class=\"token punctuation\">:</span> kubernetes<span class=\"token punctuation\">.</span>io<span class=\"token operator\">/</span>aws<span class=\"token operator\">-</span><span class=\"token class-name\">ebs</span>\n  parameters<span class=\"token punctuation\">:</span>\n  type<span class=\"token punctuation\">:</span> <span class=\"token class-name\">gp2</span>\n  reclaimPolicy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Retain</span>\n  allowVolumeExpansion<span class=\"token punctuation\">:</span> <span class=\"token class-name\">true</span>\n  mountOptions<span class=\"token punctuation\">:</span>\n   <span class=\"token operator\">-</span> <span class=\"token class-name\">debug</span>\n  volumeBindingMode<span class=\"token punctuation\">:</span> Immediate</code></pre></div>\n<ul>\n<li>즉 간단하게 말해서 PV를 미리 선언해주는 것이라고 이해하는게 편하다.</li>\n<li>보통 PV 선언 -> PVC 선언의 과정을 거쳐야 하지만 스토리지 클래스를 미리 정의해놓으면 PV선언 과정을 생략할 수 있다.</li>\n</ul>\n</li>\n</ul>\n<br/>\n<hr>\n<h2 id=\"-이제-gcp의-nfsfilestore를-구성해보죠\" style=\"position:relative;\"><a href=\"#-%EC%9D%B4%EC%A0%9C-gcp%EC%9D%98-nfsfilestore%EB%A5%BC-%EA%B5%AC%EC%84%B1%ED%95%B4%EB%B3%B4%EC%A3%A0\" aria-label=\" 이제 gcp의 nfsfilestore를 구성해보죠 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>✌ 이제 GCP의 NFS(Filestore)를 구성해보죠</h2>\n<br/>\n<h3 id=\"gcp-nfs-설정\" style=\"position:relative;\"><a href=\"#gcp-nfs-%EC%84%A4%EC%A0%95\" aria-label=\"gcp nfs 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>GCP NFS 설정</h3>\n<br/>\n<ul>\n<li>\n<p>우선 GCP Console에서 FILEStore API를 설치해줍니다</p>\n<p><img src=\"https://user-images.githubusercontent.com/69498804/96854037-0404b780-1496-11eb-81c4-922d294a441d.png\" alt=\"스크린샷, 2020-10-22 18-39-50\"></p>\n</li>\n</ul>\n<br/>\n<ul>\n<li>\n<p>그 후 Console TAP의 Filestore 메뉴에서 인스턴스를 생성해줍니다</p>\n<p><img src=\"https://user-images.githubusercontent.com/69498804/96854705-c3f20480-1496-11eb-89dc-3a46f4b99df6.png\" alt=\"스크린샷, 2020-10-22 18-45-28\"></p>\n</li>\n</ul>\n<br/>\n<ul>\n<li>\n<p>생성이 완료되었다면 자동으로 NFS가 연동됩니다. 임시로 Jenkins 인스턴스에서 Showmount 명령으로 확인해봅시다</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token punctuation\">[</span>root@jenkins <span class=\"token operator\">~</span><span class=\"token punctuation\">]</span># \n<span class=\"token punctuation\">[</span>root@jenkins <span class=\"token operator\">~</span><span class=\"token punctuation\">]</span># showmount <span class=\"token operator\">-</span>e <span class=\"token number\">10.254</span><span class=\"token number\">.194</span><span class=\"token number\">.122</span>\nExport list <span class=\"token keyword\">for</span> <span class=\"token number\">10.254</span><span class=\"token number\">.194</span><span class=\"token number\">.122</span><span class=\"token punctuation\">:</span>\n<span class=\"token operator\">/</span>nfs_share <span class=\"token number\">192.168</span><span class=\"token number\">.0</span><span class=\"token number\">.0</span><span class=\"token operator\">/</span><span class=\"token number\">16</span><span class=\"token punctuation\">,</span><span class=\"token number\">172.16</span><span class=\"token number\">.0</span><span class=\"token number\">.0</span><span class=\"token operator\">/</span><span class=\"token number\">12</span><span class=\"token punctuation\">,</span><span class=\"token number\">10.0</span><span class=\"token number\">.0</span><span class=\"token number\">.0</span><span class=\"token operator\">/</span><span class=\"token number\">8</span>\n<span class=\"token punctuation\">[</span>root@jenkins <span class=\"token operator\">~</span><span class=\"token punctuation\">]</span># \n<span class=\"token punctuation\">[</span>root@jenkins <span class=\"token operator\">~</span><span class=\"token punctuation\">]</span># </code></pre></div>\n<p>NFS끼리 잘 연결되어있는걸 확인했습니다!!</p>\n</li>\n</ul>\n<br/>\n<p><code class=\"language-text\">FileStore를 이용한 NFS 구성은 정말 간단합니다. 비용만아니면 매일 쓰고 싶네요</code></p>\n<br/>\n<hr>\n<h3 id=\"nfs를-gke의-볼륨으로-사용\" style=\"position:relative;\"><a href=\"#nfs%EB%A5%BC-gke%EC%9D%98-%EB%B3%BC%EB%A5%A8%EC%9C%BC%EB%A1%9C-%EC%82%AC%EC%9A%A9\" aria-label=\"nfs를 gke의 볼륨으로 사용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>NFS를 GKE의 볼륨으로 사용</h3>\n<p><a href=\"https://cloud.google.com/filestore/docs/accessing-fileshares?hl=ko\">공식 문서</a></p>\n<br/>\n<br/>\n<h3 id=\"pv-생성\" style=\"position:relative;\"><a href=\"#pv-%EC%83%9D%EC%84%B1\" aria-label=\"pv 생성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PV 생성</h3>\n<ul>\n<li>\n<p>NFS를 볼륨으로 이용하기 위해서 아래와 같은 메니페스트 파일을 작성했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">apiVersion<span class=\"token punctuation\">:</span> <span class=\"token class-name\">v1</span>\nkind<span class=\"token punctuation\">:</span> <span class=\"token class-name\">PersistentVolume</span>\nmetadata<span class=\"token punctuation\">:</span>\n    name<span class=\"token punctuation\">:</span> dbserver\n    <span class=\"token keyword\">namespace</span><span class=\"token punctuation\">:</span> cd<span class=\"token operator\">-</span><span class=\"token class-name\">test</span>\nspec<span class=\"token punctuation\">:</span>\n    capacity<span class=\"token punctuation\">:</span>\n    storage<span class=\"token punctuation\">:</span> 10Gi\nvolumeMode<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Filesystem</span>\naccessModes<span class=\"token punctuation\">:</span>\n<span class=\"token operator\">-</span> <span class=\"token class-name\">ReadWriteMany</span>\npersistentVolumeReclaimPolicy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Retain</span>\nstorageClassName<span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\nnfs<span class=\"token punctuation\">:</span>\n    path<span class=\"token punctuation\">:</span> <span class=\"token operator\">/</span><span class=\"token class-name\">nfs_share</span>\n    server<span class=\"token punctuation\">:</span> <span class=\"token number\">10.254</span><span class=\"token number\">.194</span><span class=\"token number\">.122</span></code></pre></div>\n<p>PV를 생성할때 NFS서버의 IP와 path를 제대로 설정해주지 않으면<br>\n아래와 같은 <code class=\"language-text\">NFS MOUNT ERROR</code>가 발생합니다</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">Search\nWarning\tFailedMount\tUnable to attach <span class=\"token keyword\">or</span> <span class=\"token class-name\">mount</span> volumes<span class=\"token punctuation\">:</span> <span class=\"token class-name\">unmounted</span> volumes<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>mysql<span class=\"token operator\">-</span>vol<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">unattached</span> volumes<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token keyword\">default</span><span class=\"token operator\">-</span>token<span class=\"token operator\">-</span>6778k mysql<span class=\"token operator\">-</span>vol<span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> timed <span class=\"token keyword\">out</span> waiting <span class=\"token keyword\">for</span> the condition\t<span class=\"token number\">2</span> minutes ago\nWarning\tFailedMount\tMountVolume<span class=\"token punctuation\">.</span>SetUp failed <span class=\"token keyword\">for</span> volume <span class=\"token string\">\"dbserver\"</span> <span class=\"token punctuation\">:</span> <span class=\"token class-name\">mount</span> failed<span class=\"token punctuation\">:</span> exit status <span class=\"token number\">1</span> <span class=\"token class-name\">Mounting</span> command<span class=\"token punctuation\">:</span> systemd<span class=\"token operator\">-</span>run <span class=\"token class-name\">Mounting</span> arguments<span class=\"token punctuation\">:</span> <span class=\"token operator\">--</span>description<span class=\"token operator\">=</span>Kubernetes transient mount <span class=\"token keyword\">for</span> <span class=\"token operator\">/</span><span class=\"token keyword\">var</span><span class=\"token operator\">/</span>lib<span class=\"token operator\">/</span>kubelet<span class=\"token operator\">/</span>pods<span class=\"token operator\">/</span>d28155b1<span class=\"token operator\">-</span>9c27<span class=\"token operator\">-</span>4f6e<span class=\"token operator\">-</span>b1b7<span class=\"token operator\">-</span>9169c926f784<span class=\"token operator\">/</span>volumes<span class=\"token operator\">/</span>kubernetes<span class=\"token punctuation\">.</span>io<span class=\"token operator\">~</span>nfs<span class=\"token operator\">/</span>dbserver <span class=\"token operator\">--</span>scope <span class=\"token operator\">--</span> <span class=\"token operator\">/</span>home<span class=\"token operator\">/</span>kubernetes<span class=\"token operator\">/</span>containerized_mounter<span class=\"token operator\">/</span>mounter mount <span class=\"token operator\">-</span>t nfs <span class=\"token operator\">-</span><span class=\"token class-name\">o</span> hard<span class=\"token punctuation\">,</span>nfsvers<span class=\"token operator\">=</span><span class=\"token number\">3</span> <span class=\"token number\">10.254</span><span class=\"token number\">.194</span><span class=\"token number\">.120</span><span class=\"token punctuation\">:</span><span class=\"token operator\">/</span>file<span class=\"token operator\">-</span>share <span class=\"token operator\">/</span><span class=\"token keyword\">var</span><span class=\"token operator\">/</span>lib<span class=\"token operator\">/</span>kubelet<span class=\"token operator\">/</span>pods<span class=\"token operator\">/</span>d28155b1<span class=\"token operator\">-</span>9c27<span class=\"token operator\">-</span>4f6e<span class=\"token operator\">-</span>b1b7<span class=\"token operator\">-</span>9169c926f784<span class=\"token operator\">/</span>volumes<span class=\"token operator\">/</span>kubernetes<span class=\"token punctuation\">.</span>io<span class=\"token operator\">~</span>nfs<span class=\"token operator\">/</span><span class=\"token class-name\">dbserver</span> Output<span class=\"token punctuation\">:</span> Running scope <span class=\"token keyword\">as</span> <span class=\"token class-name\">unit</span><span class=\"token punctuation\">:</span> run<span class=\"token operator\">-</span>r3af88159402a4b1ab6bc70512f1cbc1d<span class=\"token punctuation\">.</span>scope <span class=\"token class-name\">Mount</span> failed<span class=\"token punctuation\">:</span> <span class=\"token class-name\">mount</span> failed<span class=\"token punctuation\">:</span> exit status <span class=\"token number\">32</span> <span class=\"token class-name\">Mounting</span> command<span class=\"token punctuation\">:</span> chroot <span class=\"token class-name\">Mounting</span> arguments<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">/</span>home<span class=\"token operator\">/</span>kubernetes<span class=\"token operator\">/</span>containerized_mounter<span class=\"token operator\">/</span>rootfs mount <span class=\"token operator\">-</span>t nfs <span class=\"token operator\">-</span><span class=\"token class-name\">o</span> hard<span class=\"token punctuation\">,</span>nfsvers<span class=\"token operator\">=</span><span class=\"token number\">3</span> <span class=\"token number\">10.254</span><span class=\"token number\">.194</span><span class=\"token number\">.120</span><span class=\"token punctuation\">:</span><span class=\"token operator\">/</span>file<span class=\"token operator\">-</span>share <span class=\"token operator\">/</span><span class=\"token keyword\">var</span><span class=\"token operator\">/</span>lib<span class=\"token operator\">/</span>kubelet<span class=\"token operator\">/</span>pods<span class=\"token operator\">/</span>d28155b1<span class=\"token operator\">-</span>9c27<span class=\"token operator\">-</span>4f6e<span class=\"token operator\">-</span>b1b7<span class=\"token operator\">-</span>9169c926f784<span class=\"token operator\">/</span>volumes<span class=\"token operator\">/</span>kubernetes<span class=\"token punctuation\">.</span>io<span class=\"token operator\">~</span>nfs<span class=\"token operator\">/</span>dbserver<span class=\"token punctuation\">]</span> Output<span class=\"token punctuation\">:</span> mount<span class=\"token punctuation\">.</span>nfs<span class=\"token punctuation\">:</span> Connection timed <span class=\"token keyword\">out</span>\t<span class=\"token number\">2</span> minutes ago</code></pre></div>\n<br/>\n</li>\n<li>추가적으로 storageClassName: \"\" 항목을 None으로 둬야만 합니다.<br>\n그래야 GKE 기본 스토리지 클래스인 GCP-PD 형식의 PV를 생성하지 않기 때문에<br>\nNONE이 필수적입니다! 이 항목도 NONE이 아닐 경우 위와 같은 에러가 발생합니다.</li>\n</ul>\n<br/>\n<hr>\n<h3 id=\"pvc-생성\" style=\"position:relative;\"><a href=\"#pvc-%EC%83%9D%EC%84%B1\" aria-label=\"pvc 생성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PVC 생성</h3>\n<ul>\n<li>\n<p>NFS를 볼륨으로 이용하기 위해서 아래와 같은 메니페스트 파일을 작성했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">apiVersion<span class=\"token punctuation\">:</span> <span class=\"token class-name\">v1</span>\nkind<span class=\"token punctuation\">:</span> <span class=\"token class-name\">PersistentVolumeClaim</span>\nmetadata<span class=\"token punctuation\">:</span>\n    creationTimestamp<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\n    labels<span class=\"token punctuation\">:</span>\n        io<span class=\"token punctuation\">.</span>kompose<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">:</span> <span class=\"token class-name\">mysql</span>\n    name<span class=\"token punctuation\">:</span> mysql<span class=\"token operator\">-</span>pvc\n    <span class=\"token keyword\">namespace</span><span class=\"token punctuation\">:</span> cd<span class=\"token operator\">-</span><span class=\"token class-name\">test</span>\nspec<span class=\"token punctuation\">:</span>\n  accessModes<span class=\"token punctuation\">:</span>\n  <span class=\"token operator\">-</span> <span class=\"token class-name\">ReadWriteMany</span>\n  storageClassName<span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n  volumeName<span class=\"token punctuation\">:</span> <span class=\"token class-name\">dbserver</span>\n  resources<span class=\"token punctuation\">:</span>\n    requests<span class=\"token punctuation\">:</span>\n      storage<span class=\"token punctuation\">:</span> 5Gi\nstatus<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>PVC의 경우 별로 바꿔줄 것이 없습니다. 다만 <code class=\"language-text\">storageClassName = NONE</code>이기 때문에<br>\n<code class=\"language-text\">volumeName: dbserver</code> 항목으로 PV를 잡아주어야 원할하게 바운딩 됩니다!</p>\n</li>\n</ul>\n<br/>\n<ul>\n<li>\n<p>그럼 PVC를 생성했으니 PV &#x3C;-> PVC가 바운딩되었는지 확인해봅시다</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token operator\">></span> kubectl <span class=\"token keyword\">get</span> pv <span class=\"token operator\">-</span>n cd<span class=\"token operator\">-</span>test\nNAME       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM               STORAGECLASS   REASON   AGE\ndbserver   10Gi       RWX            Retain           Bound    cd<span class=\"token operator\">-</span>test<span class=\"token operator\">/</span>mysql<span class=\"token operator\">-</span>pvc                           <span class=\"token number\">28m</span>\n<span class=\"token operator\">></span> kubectl <span class=\"token keyword\">get</span> pvc <span class=\"token operator\">-</span>n cd<span class=\"token operator\">-</span>test\nNAME        STATUS   VOLUME     CAPACITY   ACCESS MODES   STORAGECLASS   AGE\nmysql<span class=\"token operator\">-</span>pvc   Bound    dbserver   10Gi       RWX                           <span class=\"token number\">28m</span></code></pre></div>\n<p>너무 정상적입니다~ 이제 MYSQL POD를 배포해봅시다!</p>\n</li>\n</ul>\n<br/>\n<hr>\n<h3 id=\"mysql-pod-배포\" style=\"position:relative;\"><a href=\"#mysql-pod-%EB%B0%B0%ED%8F%AC\" aria-label=\"mysql pod 배포 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MYSQL POD 배포</h3>\n<br/>\n<ul>\n<li>\n<p>MYSQL 배포를 위해 아래와 같은 메니페스트 파일을 작성했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">apiVersion<span class=\"token punctuation\">:</span> apps<span class=\"token operator\">/</span><span class=\"token class-name\">v1</span>\nkind<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Deployment</span>\nmetadata<span class=\"token punctuation\">:</span>\nannotations<span class=\"token punctuation\">:</span>\n    kompose<span class=\"token punctuation\">.</span>cmd<span class=\"token punctuation\">:</span> kompose convert\n    kompose<span class=\"token punctuation\">.</span>version<span class=\"token punctuation\">:</span> <span class=\"token number\">1.21</span><span class=\"token number\">.0</span> <span class=\"token punctuation\">(</span>992df58d8<span class=\"token punctuation\">)</span>\ncreationTimestamp<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\nlabels<span class=\"token punctuation\">:</span>\n    io<span class=\"token punctuation\">.</span>kompose<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">:</span> <span class=\"token class-name\">mysql</span>\nname<span class=\"token punctuation\">:</span> <span class=\"token class-name\">mysql</span>\nspec<span class=\"token punctuation\">:</span>\nreplicas<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\nselector<span class=\"token punctuation\">:</span>\n    matchLabels<span class=\"token punctuation\">:</span>\n    io<span class=\"token punctuation\">.</span>kompose<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">:</span> <span class=\"token class-name\">mysql</span>\nstrategy<span class=\"token punctuation\">:</span>\n    type<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Recreate</span>\ntemplate<span class=\"token punctuation\">:</span>\n    metadata<span class=\"token punctuation\">:</span>\n    annotations<span class=\"token punctuation\">:</span>\n        kompose<span class=\"token punctuation\">.</span>cmd<span class=\"token punctuation\">:</span> kompose convert\n        kompose<span class=\"token punctuation\">.</span>version<span class=\"token punctuation\">:</span> <span class=\"token number\">1.21</span><span class=\"token number\">.0</span> <span class=\"token punctuation\">(</span>992df58d8<span class=\"token punctuation\">)</span>\n    creationTimestamp<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\n    labels<span class=\"token punctuation\">:</span>\n        io<span class=\"token punctuation\">.</span>kompose<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">:</span> <span class=\"token class-name\">mysql</span>\n    spec<span class=\"token punctuation\">:</span>\n    containers<span class=\"token punctuation\">:</span>\n    <span class=\"token operator\">-</span> env<span class=\"token punctuation\">:</span>\n        <span class=\"token operator\">-</span> name<span class=\"token punctuation\">:</span> <span class=\"token class-name\">MYSQL_ROOT_PASSWORD</span>\n        <span class=\"token keyword\">value</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>비번은 안댑니다<span class=\"token punctuation\">]</span>\n        image<span class=\"token punctuation\">:</span> mysql<span class=\"token punctuation\">:</span><span class=\"token number\">5.5</span>\n        imagePullPolicy<span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n        name<span class=\"token punctuation\">:</span> <span class=\"token class-name\">mysql</span>\n        resources<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n        volumeMounts<span class=\"token punctuation\">:</span>\n        <span class=\"token operator\">-</span> mountPath<span class=\"token punctuation\">:</span> <span class=\"token operator\">/</span><span class=\"token keyword\">var</span><span class=\"token operator\">/</span>lib<span class=\"token operator\">/</span><span class=\"token class-name\">mysql</span>\n        name<span class=\"token punctuation\">:</span> mysql<span class=\"token operator\">-</span><span class=\"token class-name\">vol</span>\n    restartPolicy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Always</span>\n    serviceAccountName<span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    volumes<span class=\"token punctuation\">:</span>\n    <span class=\"token operator\">-</span> name<span class=\"token punctuation\">:</span> mysql<span class=\"token operator\">-</span><span class=\"token class-name\">vol</span>\n        persistentVolumeClaim<span class=\"token punctuation\">:</span>\n        claimName<span class=\"token punctuation\">:</span> mysql<span class=\"token operator\">-</span><span class=\"token class-name\">pvc</span>\n    status<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n<br/>\n<ul>\n<li>\n<p>다음과 같은 배포 메니페스트로 배포를 하면! 아래와 같이 정상적으로 구동이 됩니다!!</p>\n<p><img src=\"https://user-images.githubusercontent.com/69498804/96962891-a7aba180-1542-11eb-9d2d-3eb34c814aed.png\" alt=\"스크린샷, 2020-10-23 15-15-52\"></p>\n</li>\n</ul>\n<br/>\n<hr>\n<h3 id=\"에러-발생ㅠ\" style=\"position:relative;\"><a href=\"#%EC%97%90%EB%9F%AC-%EB%B0%9C%EC%83%9D%E3%85%A0\" aria-label=\"에러 발생ㅠ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>에러 발생..ㅠ</h3>\n<p><code class=\"language-text\">MYSQL Unable to lock ./ib_logfile0, error: 11</code></p>\n<br/>\n<ul>\n<li>\n<p>MYSQL Deployment에 Replicas 를 2로 설정 후 이중화를 하려니깐 아래와 같은 ERROR가 발생하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token number\">201023</span>  <span class=\"token number\">5</span><span class=\"token punctuation\">:</span><span class=\"token number\">30</span><span class=\"token punctuation\">:</span><span class=\"token number\">32</span> <span class=\"token punctuation\">[</span>Note<span class=\"token punctuation\">]</span> <span class=\"token operator\">--</span>secure<span class=\"token operator\">-</span>file<span class=\"token operator\">-</span>priv <span class=\"token keyword\">is</span> <span class=\"token keyword\">set</span> to NULL<span class=\"token punctuation\">.</span> Operations related to importing <span class=\"token keyword\">and</span> exporting data are disabled\n<span class=\"token number\">201023</span>  <span class=\"token number\">5</span><span class=\"token punctuation\">:</span><span class=\"token number\">30</span><span class=\"token punctuation\">:</span><span class=\"token number\">32</span> <span class=\"token punctuation\">[</span>Note<span class=\"token punctuation\">]</span> mysqld <span class=\"token punctuation\">(</span>mysqld <span class=\"token number\">5.5</span><span class=\"token number\">.62</span><span class=\"token punctuation\">)</span> starting <span class=\"token keyword\">as</span> <span class=\"token class-name\">process</span> <span class=\"token number\">1</span> <span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">201023</span>  <span class=\"token number\">5</span><span class=\"token punctuation\">:</span><span class=\"token number\">30</span><span class=\"token punctuation\">:</span><span class=\"token number\">32</span> <span class=\"token punctuation\">[</span>Note<span class=\"token punctuation\">]</span> Plugin 'FEDERATED' <span class=\"token keyword\">is</span> <span class=\"token class-name\">disabled</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">201023</span>  <span class=\"token number\">5</span><span class=\"token punctuation\">:</span><span class=\"token number\">30</span><span class=\"token punctuation\">:</span><span class=\"token number\">32</span> InnoDB<span class=\"token punctuation\">:</span> The InnoDB memory heap <span class=\"token keyword\">is</span> <span class=\"token class-name\">disabled</span>\n<span class=\"token number\">201023</span>  <span class=\"token number\">5</span><span class=\"token punctuation\">:</span><span class=\"token number\">30</span><span class=\"token punctuation\">:</span><span class=\"token number\">32</span> InnoDB<span class=\"token punctuation\">:</span> Mutexes <span class=\"token keyword\">and</span> rw_locks use GCC atomic builtins\n<span class=\"token number\">201023</span>  <span class=\"token number\">5</span><span class=\"token punctuation\">:</span><span class=\"token number\">30</span><span class=\"token punctuation\">:</span><span class=\"token number\">32</span> InnoDB<span class=\"token punctuation\">:</span> Compressed tables use zlib <span class=\"token number\">1.2</span><span class=\"token number\">.11</span>\n<span class=\"token number\">201023</span>  <span class=\"token number\">5</span><span class=\"token punctuation\">:</span><span class=\"token number\">30</span><span class=\"token punctuation\">:</span><span class=\"token number\">32</span> InnoDB<span class=\"token punctuation\">:</span> Using Linux native AIO\n<span class=\"token number\">201023</span>  <span class=\"token number\">5</span><span class=\"token punctuation\">:</span><span class=\"token number\">30</span><span class=\"token punctuation\">:</span><span class=\"token number\">32</span> InnoDB<span class=\"token punctuation\">:</span> Initializing <span class=\"token class-name\">buffer</span> pool<span class=\"token punctuation\">,</span> size <span class=\"token operator\">=</span> <span class=\"token number\">128.0M</span>\n<span class=\"token number\">201023</span>  <span class=\"token number\">5</span><span class=\"token punctuation\">:</span><span class=\"token number\">30</span><span class=\"token punctuation\">:</span><span class=\"token number\">32</span> InnoDB<span class=\"token punctuation\">:</span> Completed initialization of buffer <span class=\"token class-name\">pool</span>\nInnoDB<span class=\"token punctuation\">:</span> Unable to <span class=\"token keyword\">lock</span> <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>ib_logfile0<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">error</span><span class=\"token punctuation\">:</span> <span class=\"token number\">11</span>\nInnoDB<span class=\"token punctuation\">:</span> Check that you <span class=\"token keyword\">do</span> <span class=\"token keyword\">not</span> already have another mysqld <span class=\"token class-name\">process</span>\nInnoDB<span class=\"token punctuation\">:</span> <span class=\"token keyword\">using</span> the same InnoDB data <span class=\"token keyword\">or</span> log files<span class=\"token punctuation\">.</span>\nInnoDB<span class=\"token punctuation\">:</span> Error <span class=\"token keyword\">in</span> opening <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>ib_logfile0\n<span class=\"token number\">201023</span>  <span class=\"token number\">5</span><span class=\"token punctuation\">:</span><span class=\"token number\">30</span><span class=\"token punctuation\">:</span><span class=\"token number\">32</span> <span class=\"token punctuation\">[</span>ERROR<span class=\"token punctuation\">]</span> Plugin 'InnoDB' init function returned error<span class=\"token punctuation\">.</span>\n<span class=\"token number\">201023</span>  <span class=\"token number\">5</span><span class=\"token punctuation\">:</span><span class=\"token number\">30</span><span class=\"token punctuation\">:</span><span class=\"token number\">32</span> <span class=\"token punctuation\">[</span>ERROR<span class=\"token punctuation\">]</span> Plugin 'InnoDB' registration <span class=\"token keyword\">as</span> <span class=\"token class-name\">a</span> STORAGE ENGINE failed<span class=\"token punctuation\">.</span>\n<span class=\"token number\">201023</span>  <span class=\"token number\">5</span><span class=\"token punctuation\">:</span><span class=\"token number\">30</span><span class=\"token punctuation\">:</span><span class=\"token number\">32</span> <span class=\"token punctuation\">[</span>ERROR<span class=\"token punctuation\">]</span> Unknown<span class=\"token operator\">/</span>unsupported <span class=\"token class-name\">storage</span> engine<span class=\"token punctuation\">:</span> InnoDB\n<span class=\"token number\">201023</span>  <span class=\"token number\">5</span><span class=\"token punctuation\">:</span><span class=\"token number\">30</span><span class=\"token punctuation\">:</span><span class=\"token number\">32</span> <span class=\"token punctuation\">[</span>ERROR<span class=\"token punctuation\">]</span> Aborting\n<span class=\"token number\">201023</span>  <span class=\"token number\">5</span><span class=\"token punctuation\">:</span><span class=\"token number\">30</span><span class=\"token punctuation\">:</span><span class=\"token number\">32</span> <span class=\"token punctuation\">[</span>Note<span class=\"token punctuation\">]</span> mysqld<span class=\"token punctuation\">:</span> Shutdown complete</code></pre></div>\n</li>\n</ul>\n<br/>\n<ul>\n<li>검색을 쫌 해보니 내 환경은 NFS로 data파일을 받아오는 구조이다 보니 한쪽의 MYSQL Pod가 mysql을 실행시키면서<br>\n해당 데이터파일을 사용하고 있으면 다른쪽에서는 사용하지 못하는 이슈였다.</li>\n</ul>\n<br/>\n<ul>\n<li>\n<p>Rancher UI에서 확인해보니 컨테이너가 계속 재시작 되고 있다 ㅠㅠ</p>\n<p><img src=\"https://user-images.githubusercontent.com/69498804/96963063-f35e4b00-1542-11eb-8671-2c25c1f6236d.png\" alt=\"스크린샷, 2020-10-23 14-15-19\"></p>\n</li>\n</ul>\n<br/>\n<ul>\n<li>머리말에서도 언급했듯이 이중화보다는 NFS로 DB 데이터를 받아오는 것과 별 차이가 없다고 생각을 했습니다.<br>\n그래서 위의 Mysql 배포 메니페스트 파일의 replicas를 1로 두는 것으로 마무리 했습니다</li>\n</ul>\n<hr>\n<h3 id=\"nfs---mysql-data-연동-확인\" style=\"position:relative;\"><a href=\"#nfs---mysql-data-%EC%97%B0%EB%8F%99-%ED%99%95%EC%9D%B8\" aria-label=\"nfs   mysql data 연동 확인 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>NFS &#x3C;-> Mysql Data 연동 확인</h3>\n<p>replicas를 1로 두어 NFS와 데이터파일을 연동한 POD에서 확인해봅시다!</p>\n<ul>\n<li>\n<p>우선 MYSQL과 연동한 취약점 검사 WEB에서 아이디를 하나 만들어보죠 해당 ID 데이터는 MYSQL DB에 저장됩니다</p>\n<p><img src=\"https://user-images.githubusercontent.com/69498804/96963398-8c8d6180-1543-11eb-8cb1-52c331066848.png\" alt=\"스크린샷, 2020-10-23 15-22-18\"></p>\n<p>test2라는 User를 만들었습니다</p>\n<p><img src=\"https://user-images.githubusercontent.com/69498804/96963649-f148bc00-1543-11eb-9ff7-25c533985471.png\" alt=\"스크린샷, 2020-10-23 15-25-06\"></p>\n</li>\n</ul>\n<br/>\n<ul>\n<li>\n<p>MYSQL POD로 가서 데이터를 확인해봅시다.</p>\n<p>아래와 같이 DB Table에 Account 정보가 잘 들어와 있네요</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">mysql<span class=\"token operator\">></span> \nmysql<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> users<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">+</span>\n<span class=\"token operator\">|</span> id <span class=\"token operator\">|</span> name  <span class=\"token operator\">|</span> login <span class=\"token operator\">|</span> email           <span class=\"token operator\">|</span> password                         <span class=\"token operator\">|</span> created_at          <span class=\"token operator\">|</span> updated_at          <span class=\"token operator\">|</span> role <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">+</span>\n<span class=\"token operator\">|</span> <span class=\"token number\">18</span> <span class=\"token operator\">|</span> test  <span class=\"token operator\">|</span> test  <span class=\"token operator\">|</span> test@gmail<span class=\"token punctuation\">.</span>com  <span class=\"token operator\">|</span> 098f6bcd4621d373cade4e832627b4f6 <span class=\"token operator\">|</span> <span class=\"token number\">2020</span><span class=\"token operator\">-</span><span class=\"token number\">10</span><span class=\"token operator\">-</span><span class=\"token number\">23</span> <span class=\"token number\">05</span><span class=\"token punctuation\">:</span><span class=\"token number\">46</span><span class=\"token punctuation\">:</span><span class=\"token number\">19</span> <span class=\"token operator\">|</span> <span class=\"token number\">2020</span><span class=\"token operator\">-</span><span class=\"token number\">10</span><span class=\"token operator\">-</span><span class=\"token number\">23</span> <span class=\"token number\">05</span><span class=\"token punctuation\">:</span><span class=\"token number\">46</span><span class=\"token punctuation\">:</span><span class=\"token number\">19</span> <span class=\"token operator\">|</span> NULL <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> <span class=\"token number\">19</span> <span class=\"token operator\">|</span> test2 <span class=\"token operator\">|</span> test2 <span class=\"token operator\">|</span> test2@naver<span class=\"token punctuation\">.</span>com <span class=\"token operator\">|</span> ad0234829205b9033196ba818f7a872b <span class=\"token operator\">|</span> <span class=\"token number\">2020</span><span class=\"token operator\">-</span><span class=\"token number\">10</span><span class=\"token operator\">-</span><span class=\"token number\">23</span> <span class=\"token number\">06</span><span class=\"token punctuation\">:</span><span class=\"token number\">24</span><span class=\"token punctuation\">:</span><span class=\"token number\">54</span> <span class=\"token operator\">|</span> <span class=\"token number\">2020</span><span class=\"token operator\">-</span><span class=\"token number\">10</span><span class=\"token operator\">-</span><span class=\"token number\">23</span> <span class=\"token number\">06</span><span class=\"token punctuation\">:</span><span class=\"token number\">24</span><span class=\"token punctuation\">:</span><span class=\"token number\">54</span> <span class=\"token operator\">|</span> NULL <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">+</span>\n<span class=\"token number\">2</span> rows <span class=\"token keyword\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n</ul>\n<br/>\n<hr>\n<h3 id=\"이제-mysql-pod를-강제로-죽인-뒤-다시-가동시켜서-db-data를-확인해보겠습니다\" style=\"position:relative;\"><a href=\"#%EC%9D%B4%EC%A0%9C-mysql-pod%EB%A5%BC-%EA%B0%95%EC%A0%9C%EB%A1%9C-%EC%A3%BD%EC%9D%B8-%EB%92%A4-%EB%8B%A4%EC%8B%9C-%EA%B0%80%EB%8F%99%EC%8B%9C%EC%BC%9C%EC%84%9C-db-data%EB%A5%BC-%ED%99%95%EC%9D%B8%ED%95%B4%EB%B3%B4%EA%B2%A0%EC%8A%B5%EB%8B%88%EB%8B%A4\" aria-label=\"이제 mysql pod를 강제로 죽인 뒤 다시 가동시켜서 db data를 확인해보겠습니다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>이제 MYSQL POD를 강제로 죽인 뒤 다시 가동시켜서 DB DATA를 확인해보겠습니다</h3>\n<br/>\n<ul>\n<li>\n<p>Rancher에서는 POD를 다음과 같이 간단하게 종료 시킬 수 있습니다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/69498804/96963953-8ea3f000-1544-11eb-9963-c488299be958.png\" alt=\"스크린샷, 2020-10-23 15-29-29\"></p>\n</li>\n</ul>\n<br/>\n<ul>\n<li>\n<p>Deployement가 POD를 재시작 시켜 이전과 다른 이름으로 컨테이너가 가동 됐습니다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/69498804/96964025-ad09eb80-1544-11eb-9bd6-0f30336e6e03.png\" alt=\"스크린샷, 2020-10-23 15-30-20\"></p>\n</li>\n</ul>\n<br/>\n<ul>\n<li>\n<p>새로 생성된 컨테이너에 접속해서 DB 데이터를 보면 기존에 추가했던 test2 user 정보가 남아있습니다</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">mysql<span class=\"token operator\">></span> use dvja\nReading table information <span class=\"token keyword\">for</span> completion of table <span class=\"token keyword\">and</span> column names\nYou can turn off <span class=\"token keyword\">this</span> feature to <span class=\"token keyword\">get</span> a quicker startup with <span class=\"token operator\">-</span>A\n\nDatabase changed\nmysql<span class=\"token operator\">></span> <span class=\"token class-name\">show</span> tables<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">+</span>\n<span class=\"token operator\">|</span> Tables_in_dvja <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">+</span>\n<span class=\"token operator\">|</span> products       <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> users          <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">+</span>\n<span class=\"token number\">2</span> rows <span class=\"token keyword\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n\nmysql<span class=\"token operator\">></span> \nmysql<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> users<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">+</span>\n<span class=\"token operator\">|</span> id <span class=\"token operator\">|</span> name  <span class=\"token operator\">|</span> login <span class=\"token operator\">|</span> email           <span class=\"token operator\">|</span> password                         <span class=\"token operator\">|</span> created_at          <span class=\"token operator\">|</span> updated_at          <span class=\"token operator\">|</span> role <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">+</span>\n<span class=\"token operator\">|</span> <span class=\"token number\">18</span> <span class=\"token operator\">|</span> test  <span class=\"token operator\">|</span> test  <span class=\"token operator\">|</span> test@gmail<span class=\"token punctuation\">.</span>com  <span class=\"token operator\">|</span> 098f6bcd4621d373cade4e832627b4f6 <span class=\"token operator\">|</span> <span class=\"token number\">2020</span><span class=\"token operator\">-</span><span class=\"token number\">10</span><span class=\"token operator\">-</span><span class=\"token number\">23</span> <span class=\"token number\">05</span><span class=\"token punctuation\">:</span><span class=\"token number\">46</span><span class=\"token punctuation\">:</span><span class=\"token number\">19</span> <span class=\"token operator\">|</span> <span class=\"token number\">2020</span><span class=\"token operator\">-</span><span class=\"token number\">10</span><span class=\"token operator\">-</span><span class=\"token number\">23</span> <span class=\"token number\">05</span><span class=\"token punctuation\">:</span><span class=\"token number\">46</span><span class=\"token punctuation\">:</span><span class=\"token number\">19</span> <span class=\"token operator\">|</span> NULL <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> <span class=\"token number\">19</span> <span class=\"token operator\">|</span> test2 <span class=\"token operator\">|</span> test2 <span class=\"token operator\">|</span> test2@naver<span class=\"token punctuation\">.</span>com <span class=\"token operator\">|</span> ad0234829205b9033196ba818f7a872b <span class=\"token operator\">|</span> <span class=\"token number\">2020</span><span class=\"token operator\">-</span><span class=\"token number\">10</span><span class=\"token operator\">-</span><span class=\"token number\">23</span> <span class=\"token number\">06</span><span class=\"token punctuation\">:</span><span class=\"token number\">24</span><span class=\"token punctuation\">:</span><span class=\"token number\">54</span> <span class=\"token operator\">|</span> <span class=\"token number\">2020</span><span class=\"token operator\">-</span><span class=\"token number\">10</span><span class=\"token operator\">-</span><span class=\"token number\">23</span> <span class=\"token number\">06</span><span class=\"token punctuation\">:</span><span class=\"token number\">24</span><span class=\"token punctuation\">:</span><span class=\"token number\">54</span> <span class=\"token operator\">|</span> NULL <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">+</span>\n<span class=\"token number\">2</span> rows <span class=\"token keyword\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n\nmysql<span class=\"token operator\">></span> </code></pre></div>\n</li>\n</ul>\n<br/>\n<ul>\n<li>\n<p>물론 웹페이지에서도 접속이 원활합니다</p>\n<p><img src=\"https://user-images.githubusercontent.com/69498804/96964242-17229080-1545-11eb-8632-0a6251fc34d8.png\" alt=\"스크린샷, 2020-10-23 15-33-20\"></p>\n</li>\n</ul>\n<br/>\n<hr>\n<h2 id=\"마치며\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EC%B9%98%EB%A9%B0\" aria-label=\"마치며 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마치며…</h2>\n<p>이번에 새롭게 FileStore라는 GCP의 기능을 사용해봤습니다.<br>\n진짜 이전에 노가다식으로 했었던 NFS 서버 구성이 너무 무의미해지는 서비스입니다<br>\n이번 실습은 왜 클라우드 서비스 하는지 알 것같은 실습이었습니다<br>\n비록 기존에 생각하던 MYSQL POD의 Active/slave,Heartbeat 방식의 이중화는 못했지만 nfs에서 데이터를 받아오는 것도 만족한 서비스 인 것 같습니다.\n이번 포스트까지 이제 전반적인 서비스 구성을 마무리 지은 것 같습니다.<br>\n이제는 보안툴과 취약점 검사, ARgo-cd 자동화 등을 진행해야겠죠…</p>\n<hr>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#-%EB%B0%9C%EC%83%9D-%EC%9D%B4%EC%8A%88\">✔ 발생 이슈</a></li>\n<li>\n<p><a href=\"#-%EC%9D%B4%EC%A0%9C-gcp%EC%9D%98-nfsfilestore%EB%A5%BC-%EA%B5%AC%EC%84%B1%ED%95%B4%EB%B3%B4%EC%A3%A0\">✌ 이제 GCP의 NFS(Filestore)를 구성해보죠</a></p>\n<ul>\n<li><a href=\"#gcp-nfs-%EC%84%A4%EC%A0%95\">GCP NFS 설정</a></li>\n<li><a href=\"#nfs%EB%A5%BC-gke%EC%9D%98-%EB%B3%BC%EB%A5%A8%EC%9C%BC%EB%A1%9C-%EC%82%AC%EC%9A%A9\">NFS를 GKE의 볼륨으로 사용</a></li>\n<li><a href=\"#pv-%EC%83%9D%EC%84%B1\">PV 생성</a></li>\n<li><a href=\"#pvc-%EC%83%9D%EC%84%B1\">PVC 생성</a></li>\n<li><a href=\"#mysql-pod-%EB%B0%B0%ED%8F%AC\">MYSQL POD 배포</a></li>\n<li><a href=\"#%EC%97%90%EB%9F%AC-%EB%B0%9C%EC%83%9D%E3%85%A0\">에러 발생..ㅠ</a></li>\n<li><a href=\"#nfs---mysql-data-%EC%97%B0%EB%8F%99-%ED%99%95%EC%9D%B8\">NFS &#x3C;-> Mysql Data 연동 확인</a></li>\n<li><a href=\"#%EC%9D%B4%EC%A0%9C-mysql-pod%EB%A5%BC-%EA%B0%95%EC%A0%9C%EB%A1%9C-%EC%A3%BD%EC%9D%B8-%EB%92%A4-%EB%8B%A4%EC%8B%9C-%EA%B0%80%EB%8F%99%EC%8B%9C%EC%BC%9C%EC%84%9C-db-data%EB%A5%BC-%ED%99%95%EC%9D%B8%ED%95%B4%EB%B3%B4%EA%B2%A0%EC%8A%B5%EB%8B%88%EB%8B%A4\">이제 MYSQL POD를 강제로 죽인 뒤 다시 가동시켜서 DB DATA를 확인해보겠습니다</a></li>\n</ul>\n</li>\n<li><a href=\"#%EB%A7%88%EC%B9%98%EB%A9%B0\">마치며…</a></li>\n</ul>\n</div>","excerpt":"머리말   이번 포스트에서는 앱 구동을 위한 MYSQL 이중화입니다 이전 포스트에서 앱 배포를 완료했지만 MYSQL pod의 경우 볼륨의 문제로 하나밖에 뜨지 않아 DB 데이터를 어떻게 저장할지에 대한 고민이 있었습니다. 고민해본 결과 NFS를 만들어서 그쪽에 데이터를 저장해놓고 POD가 실행될때마다 NFS를 읽어오자! 라는 결론이 나왔습니다 그래서 NFS 서버를 구축하려고 하려는 찰나 GCP에서 API 서비스로 제공한다는 소식을 듣고 바로 사용해 보았습니다 사용 할 툴을 다음과 같습니다.   GCP FileStore k8s PV,PVC ArgoCD ✔ 발생 이슈 MYSQL Pod를 두개 이상 띄우려고 할때 아래와 같…","frontmatter":{"date":"August 07, 2021","title":"[DEVOPS] - GCP의 FileStore (NFS) 를 PV로 사용해보자","categories":"DevOps CLOUD","author":"nasa1515","emoji":"🤦‍♂️"},"fields":{"slug":"/devops-gcpfilestore/"}},"next":{"id":"bdbab45f-6ba1-56d5-9b14-88db8da9d77d","html":"<p>머리말  </p>\n<p>이전에 구성한 파이프라인의 전체적인 자동화는 아직 구성이 안됐지만 CI, CD 각각의 자동화는 마쳤습니다.<br>\n그렇기에 이번에는 실제 보안 취약점 검사를 위한 오픈소스 툴을 Rancher 클러스터 환경에 배포해봤습니다.!!<br>\n사용할 툴은 DVMN인데 기본적으로 PHP 배포판이 대부분이지만<br>\n저는 Jenkins에서 Junit등의 취약점 분석을 조금 더 쉽게 하기 위해서 JAVA 기반의 배포판으로 MSA를 만들어 배포했습니다.</p>\n<hr>\n<p>사용 할 툴을 다음과 같습니다.  </p>\n<ul>\n<li>GITHUB</li>\n<li>ArgoCD</li>\n<li>Helm</li>\n<li>kompose</li>\n</ul>\n<br/>\n<hr>\n<h2 id=\"-dvwa-msa-생성\" style=\"position:relative;\"><a href=\"#-dvwa-msa-%EC%83%9D%EC%84%B1\" aria-label=\" dvwa msa 생성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>✔ DVWA MSA 생성</h2>\n<p><a href=\"https://github.com/appsecco/dvja\">DVMN JAVA 링크</a> 해당 주소에서 JAVA기반의 DVWA앱을 확인했습니다!!</p>\n<p>그러나 기본 JAVA 배포판은 Docker.compose.yaml만 존재하기 때문에<br>\n쿠버네티스에 MSP로 각각 배포할 수 있는 메니페스트를 직접 만들어줘야 했습니다.</p>\n<br/>\n<ul>\n<li>\n<p>kompose 툴 사용기  </p>\n<p>GOOGLE 서칭을 해보다가 docker.compose를 yaml 파일로 변환해주는 툴을 발견해서 사용해봤다.<br>\n자세한 사항은 <a href=\"https://github.com/kubernetes/kompose/blob/master/docs/installation.md#centos\">공식 GITHUB 확인!</a></p>\n</li>\n</ul>\n<br/>\n<ul>\n<li>\n<p>kompose 설치</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">root@cccr<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span>home<span class=\"token operator\">/</span>kompose# curl <span class=\"token operator\">-</span><span class=\"token class-name\">L</span> https<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>github<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>kubernetes<span class=\"token operator\">/</span>kompose<span class=\"token operator\">/</span>releases<span class=\"token operator\">/</span>download<span class=\"token operator\">/</span>v1<span class=\"token punctuation\">.</span><span class=\"token number\">22.0</span><span class=\"token operator\">/</span>kompose<span class=\"token operator\">-</span>linux<span class=\"token operator\">-</span>amd64 <span class=\"token operator\">-</span>o kompose\n<span class=\"token operator\">%</span> Total    <span class=\"token operator\">%</span> Received <span class=\"token operator\">%</span> Xferd  Average Speed   Time    Time     Time  Current\n                                Dload  Upload   Total   Spent    Left  Speed\n<span class=\"token number\">100</span>   <span class=\"token number\">643</span>  <span class=\"token number\">100</span>   <span class=\"token number\">643</span>    <span class=\"token number\">0</span>     <span class=\"token number\">0</span>   <span class=\"token number\">1391</span>      <span class=\"token number\">0</span> <span class=\"token operator\">--</span><span class=\"token punctuation\">:</span><span class=\"token operator\">--</span><span class=\"token punctuation\">:</span><span class=\"token operator\">--</span> <span class=\"token operator\">--</span><span class=\"token punctuation\">:</span><span class=\"token operator\">--</span><span class=\"token punctuation\">:</span><span class=\"token operator\">--</span> <span class=\"token operator\">--</span><span class=\"token punctuation\">:</span><span class=\"token operator\">--</span><span class=\"token punctuation\">:</span><span class=\"token operator\">--</span>  <span class=\"token number\">1388</span>\n<span class=\"token number\">100</span> <span class=\"token number\">23.8M</span>  <span class=\"token number\">100</span> <span class=\"token number\">23.8M</span>    <span class=\"token number\">0</span>     <span class=\"token number\">0</span>  3411k      <span class=\"token number\">0</span>  <span class=\"token number\">0</span><span class=\"token punctuation\">:</span><span class=\"token number\">00</span><span class=\"token punctuation\">:</span><span class=\"token number\">07</span>  <span class=\"token number\">0</span><span class=\"token punctuation\">:</span><span class=\"token number\">00</span><span class=\"token punctuation\">:</span><span class=\"token number\">07</span> <span class=\"token operator\">--</span><span class=\"token punctuation\">:</span><span class=\"token operator\">--</span><span class=\"token punctuation\">:</span><span class=\"token operator\">--</span> 4968k\nroot@cccr<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span>home<span class=\"token operator\">/</span>kompose# ls \nkompose\n\nroot@cccr<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span>home<span class=\"token operator\">/</span>kompose# chmod <span class=\"token operator\">+</span>x kompose\nroot@cccr<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span>home<span class=\"token operator\">/</span>kompose# sudo mv <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>kompose <span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span>local<span class=\"token operator\">/</span>bin<span class=\"token operator\">/</span>kompose</code></pre></div>\n</li>\n</ul>\n<br/>\n<br/>\n<ul>\n<li>\n<p>DWWA의 docker.compose.yml 파일은 아래와 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">version<span class=\"token punctuation\">:</span> <span class=\"token string character\">'2'</span>\nservices<span class=\"token punctuation\">:</span>\nmysql<span class=\"token punctuation\">:</span>\n    image<span class=\"token punctuation\">:</span> mysql<span class=\"token punctuation\">:</span><span class=\"token number\">5.5</span>\n    volumes<span class=\"token punctuation\">:</span>\n    <span class=\"token operator\">-</span> mysql<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token keyword\">var</span><span class=\"token operator\">/</span>lib<span class=\"token operator\">/</span><span class=\"token class-name\">mysql</span>\n    environment<span class=\"token punctuation\">:</span>\n    MYSQL_ROOT_PASSWORD<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ec95c258266b8e985848cae688effa2b</span>\napp<span class=\"token punctuation\">:</span>\n    build<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span>\n    depends_on<span class=\"token punctuation\">:</span>\n    <span class=\"token operator\">-</span> <span class=\"token class-name\">mysql</span>\n    ports<span class=\"token punctuation\">:</span>\n    <span class=\"token operator\">-</span> <span class=\"token string\">\"8080:8080\"</span>\n    environment<span class=\"token punctuation\">:</span>\n    MYSQL_USER<span class=\"token punctuation\">:</span> <span class=\"token class-name\">root</span>\n    MYSQL_PASSWORD<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ec95c258266b8e985848cae688effa2b</span>\nvolumes<span class=\"token punctuation\">:</span>\nmysql<span class=\"token punctuation\">:</span></code></pre></div>\n</li>\n</ul>\n<br/>\n<br/>\n<ul>\n<li>\n<p>위의 docker.compose.yml 파일을 kompose 변환기로 변환해보자!</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">root@cccr<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span>home<span class=\"token operator\">/</span>kompose# kompose convert <span class=\"token operator\">-</span>f docker<span class=\"token operator\">-</span>compose<span class=\"token punctuation\">.</span>yaml\nWARN Unsupported root level volumes key <span class=\"token operator\">-</span> ignoring \nWARN Unsupported depends_on key <span class=\"token operator\">-</span> ignoring        \nINFO Kubernetes file <span class=\"token string\">\"app-service.yaml\"</span> created   \nINFO Kubernetes file <span class=\"token string\">\"app-deployment.yaml\"</span> created \nINFO Kubernetes file <span class=\"token string\">\"mysql-deployment.yaml\"</span> created \nINFO Kubernetes file <span class=\"token string\">\"mysql-persistentvolumeclaim.yaml\"</span> created </code></pre></div>\n<p>총 4개의 파일이 yaml 파일이 생성되었다!</p>\n</li>\n</ul>\n<br/>\n<br/>\n<ul>\n<li>\n<p>간단하게 app을 배포하는 deployement yaml을 하나만 열어보자</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">apiVersion<span class=\"token punctuation\">:</span> apps<span class=\"token operator\">/</span><span class=\"token class-name\">v1</span>\nkind<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Deployment</span>\nmetadata<span class=\"token punctuation\">:</span>\n    annotations<span class=\"token punctuation\">:</span>\n        kompose<span class=\"token punctuation\">.</span>cmd<span class=\"token punctuation\">:</span> kompose convert <span class=\"token operator\">-</span>f docker<span class=\"token operator\">-</span>compose<span class=\"token punctuation\">.</span>yaml\n        kompose<span class=\"token punctuation\">.</span>version<span class=\"token punctuation\">:</span> <span class=\"token number\">1.22</span><span class=\"token number\">.0</span> <span class=\"token punctuation\">(</span>955b78124<span class=\"token punctuation\">)</span>\ncreationTimestamp<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\nlabels<span class=\"token punctuation\">:</span>\n     io<span class=\"token punctuation\">.</span>kompose<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">:</span> <span class=\"token class-name\">app</span>\n name<span class=\"token punctuation\">:</span> <span class=\"token class-name\">app</span>\nspec<span class=\"token punctuation\">:</span>\n    replicas<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n     selector<span class=\"token punctuation\">:</span>\n            matchLabels<span class=\"token punctuation\">:</span>\n            io<span class=\"token punctuation\">.</span>kompose<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">:</span> <span class=\"token class-name\">app</span>\n strategy<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n template<span class=\"token punctuation\">:</span>\n    metadata<span class=\"token punctuation\">:</span>\n     annotations<span class=\"token punctuation\">:</span>\n        kompose<span class=\"token punctuation\">.</span>cmd<span class=\"token punctuation\">:</span> kompose convert <span class=\"token operator\">-</span>f docker<span class=\"token operator\">-</span>compose<span class=\"token punctuation\">.</span>yaml\n        kompose<span class=\"token punctuation\">.</span>version<span class=\"token punctuation\">:</span> <span class=\"token number\">1.22</span><span class=\"token number\">.0</span> <span class=\"token punctuation\">(</span>955b78124<span class=\"token punctuation\">)</span>\n     creationTimestamp<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\n     labels<span class=\"token punctuation\">:</span>\n      io<span class=\"token punctuation\">.</span>kompose<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">:</span> <span class=\"token class-name\">app</span>\n    spec<span class=\"token punctuation\">:</span>\n      containers<span class=\"token punctuation\">:</span>\n         <span class=\"token operator\">-</span> env<span class=\"token punctuation\">:</span>\n              <span class=\"token operator\">-</span> name<span class=\"token punctuation\">:</span> <span class=\"token class-name\">MYSQL_PASSWORD</span>\n                <span class=\"token keyword\">value</span><span class=\"token punctuation\">:</span> ec95c258266b8e985848cae688effa2b\n              <span class=\"token operator\">-</span> name<span class=\"token punctuation\">:</span> <span class=\"token class-name\">MYSQL_USER</span>\n                <span class=\"token keyword\">value</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">root</span>\n         image<span class=\"token punctuation\">:</span> <span class=\"token class-name\">app</span>\n         name<span class=\"token punctuation\">:</span> <span class=\"token class-name\">app</span>\n        ports<span class=\"token punctuation\">:</span>\n            <span class=\"token operator\">-</span> containerPort<span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span>\n         resources<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    restartPolicy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Always</span>\nstatus<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>위와 같이 매니페스트 파일들이 생성되어 MSA를 만드는데 조금 더 시간을 절약 할 수 있었다.</p>\n</li>\n</ul>\n<br/>\n<br/>\n<ul>\n<li>\n<p>이제 k8s 클러스터에 알맞게 배포하기 위해서 메니페스트 파일들을 수정, 생성했다.</p>\n<p>ArgoCD에서 github 웹훅으로 배포하기 위해 github에 관련 메니페스트 파일들을 모두 올려놓았다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/69498804/98902408-0ab4a680-24f9-11eb-9e8c-aff3237409c9.png\" alt=\"스크린샷, 2020-11-12 15-09-11\"></p>\n</li>\n</ul>\n<br/>\n<hr>\n<h3 id=\"-메니페스트-하나씩-내용을-살펴보자\" style=\"position:relative;\"><a href=\"#-%EB%A9%94%EB%8B%88%ED%8E%98%EC%8A%A4%ED%8A%B8-%ED%95%98%EB%82%98%EC%94%A9-%EB%82%B4%EC%9A%A9%EC%9D%84-%EC%82%B4%ED%8E%B4%EB%B3%B4%EC%9E%90\" aria-label=\" 메니페스트 하나씩 내용을 살펴보자 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>✌ 메니페스트 하나씩 내용을 살펴보자.</h3>\n<p>우선 메니페스트들의 가변적으로 바뀌는 설정들을 일일히 바꾸는 작업을 간소화 하기 위해서<br>\n헬름차트 기반으로 메니페스트를 배포하기로 했다.<br>\n즉 Jenkins 서버에서는 values.yaml 파일의 이미지 tag값을 빌드 넘버로 바꾸어 배포가 되게 만든 아키텍처이다.</p>\n<br/>\n<ul>\n<li>\n<p>values.yaml </p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token preprocessor property\"># Default values for ghost.</span>\n<span class=\"token preprocessor property\"># This is a YAML-formatted file.</span>\n<span class=\"token preprocessor property\"># Declare variables to be passed into your templates.</span>\n\nreplicaCount<span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n\nimage<span class=\"token punctuation\">:</span>\nrepository<span class=\"token punctuation\">:</span> jisunpark<span class=\"token operator\">/</span>cccr<span class=\"token operator\">-</span>dvwa<span class=\"token operator\">-</span>java<span class=\"token operator\">-</span><span class=\"token class-name\">web</span>\ntag<span class=\"token punctuation\">:</span> <span class=\"token number\">13</span>     <span class=\"token operator\">&lt;&lt;</span><span class=\"token operator\">--</span>해당 값이 바뀌면 배포가 이루어진다<span class=\"token punctuation\">.</span>\npullPolicy<span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n\n\n<span class=\"token keyword\">value</span><span class=\"token punctuation\">:</span> ec95c258266b8e985848cae688effa2b\n\n<span class=\"token keyword\">namespace</span><span class=\"token punctuation\">:</span> cd<span class=\"token operator\">-</span><span class=\"token class-name\">test</span>\n\nname<span class=\"token punctuation\">:</span> \napp<span class=\"token punctuation\">:</span> app</code></pre></div>\n</li>\n</ul>\n<br/>\n<br/>\n<ul>\n<li>\n<p>app-deployment.yaml</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">apiVersion<span class=\"token punctuation\">:</span> apps<span class=\"token operator\">/</span><span class=\"token class-name\">v1</span>\nkind<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Deployment</span>\nmetadata<span class=\"token punctuation\">:</span>\nannotations<span class=\"token punctuation\">:</span>\n    kompose<span class=\"token punctuation\">.</span>cmd<span class=\"token punctuation\">:</span> kompose convert\n    kompose<span class=\"token punctuation\">.</span>version<span class=\"token punctuation\">:</span> <span class=\"token number\">1.21</span><span class=\"token number\">.0</span> <span class=\"token punctuation\">(</span>992df58d8<span class=\"token punctuation\">)</span>\ncreationTimestamp<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\nlabels<span class=\"token punctuation\">:</span>\n    io<span class=\"token punctuation\">.</span>kompose<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span>Values<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">.</span>app <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\nname<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span>Values<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">.</span>app <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\nspec<span class=\"token punctuation\">:</span>\nreplicas<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span>Values<span class=\"token punctuation\">.</span>replicaCount <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\nselector<span class=\"token punctuation\">:</span>\n    matchLabels<span class=\"token punctuation\">:</span>\n    io<span class=\"token punctuation\">.</span>kompose<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span>Values<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">.</span>app <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\nstrategy<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\ntemplate<span class=\"token punctuation\">:</span>\n    metadata<span class=\"token punctuation\">:</span>\n    annotations<span class=\"token punctuation\">:</span>\n        kompose<span class=\"token punctuation\">.</span>cmd<span class=\"token punctuation\">:</span> kompose convert\n        kompose<span class=\"token punctuation\">.</span>version<span class=\"token punctuation\">:</span> <span class=\"token number\">1.21</span><span class=\"token number\">.0</span> <span class=\"token punctuation\">(</span>992df58d8<span class=\"token punctuation\">)</span>\n    creationTimestamp<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\n    labels<span class=\"token punctuation\">:</span>\n        io<span class=\"token punctuation\">.</span>kompose<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span>Values<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">.</span>app <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    spec<span class=\"token punctuation\">:</span>\n    containers<span class=\"token punctuation\">:</span>\n    <span class=\"token operator\">-</span> env<span class=\"token punctuation\">:</span>\n        <span class=\"token operator\">-</span> name<span class=\"token punctuation\">:</span> <span class=\"token class-name\">MYSQL_PASSWORD</span>\n        <span class=\"token keyword\">value</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span>Values<span class=\"token punctuation\">.</span><span class=\"token keyword\">value</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token operator\">-</span> name<span class=\"token punctuation\">:</span> <span class=\"token class-name\">MYSQL_USER</span>\n        <span class=\"token keyword\">value</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">root</span>\n        image<span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ .Values.image.repository }}:{{ .Values.image.tag }}\"</span>\n        imagePullPolicy<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span>Values<span class=\"token punctuation\">.</span>image<span class=\"token punctuation\">.</span>pullPolicy <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        name<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span>Values<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">.</span>app <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        ports<span class=\"token punctuation\">:</span>\n        <span class=\"token operator\">-</span> containerPort<span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span>\n        resources<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    restartPolicy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Always</span>\n    serviceAccountName<span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    volumes<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\nstatus<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>간단하게 설명하면 Jenkins 에서 수정하고 빌드한 DVWA 이미지의 빌드넘버를 받아와 배포한다.</p>\n</li>\n</ul>\n<br/>\n<br/>\n<ul>\n<li>\n<p>app-service.yaml</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">apiVersion<span class=\"token punctuation\">:</span> <span class=\"token class-name\">v1</span>\nkind<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Service</span>\nmetadata<span class=\"token punctuation\">:</span>\nannotations<span class=\"token punctuation\">:</span>\n    cloud<span class=\"token punctuation\">.</span>google<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>neg<span class=\"token punctuation\">:</span> '<span class=\"token punctuation\">{</span><span class=\"token string\">\"ingress\"</span><span class=\"token punctuation\">:</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">}</span>'\n    field<span class=\"token punctuation\">.</span>cattle<span class=\"token punctuation\">.</span>io<span class=\"token operator\">/</span>publicEndpoints<span class=\"token punctuation\">:</span> '<span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"addresses\"</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"35.223.27.28\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"port\"</span><span class=\"token punctuation\">:</span><span class=\"token number\">8080</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"protocol\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"TCP\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"serviceName\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"cd-test:app\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"allNodes\"</span><span class=\"token punctuation\">:</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>'\n    kompose<span class=\"token punctuation\">.</span>cmd<span class=\"token punctuation\">:</span> kompose convert\n    kompose<span class=\"token punctuation\">.</span>version<span class=\"token punctuation\">:</span> <span class=\"token number\">1.21</span><span class=\"token number\">.0</span> <span class=\"token punctuation\">(</span>992df58d8<span class=\"token punctuation\">)</span>\nlabels<span class=\"token punctuation\">:</span>\n    io<span class=\"token punctuation\">.</span>kompose<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span>Values<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">.</span>app <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\nname<span class=\"token punctuation\">:</span> app<span class=\"token operator\">-</span>lb\n<span class=\"token keyword\">namespace</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span>Values<span class=\"token punctuation\">.</span><span class=\"token keyword\">namespace</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\nspec<span class=\"token punctuation\">:</span>\nexternalTrafficPolicy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Cluster</span>\nports<span class=\"token punctuation\">:</span>\n<span class=\"token operator\">-</span> name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"8080\"</span>\n    port<span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span>\n    protocol<span class=\"token punctuation\">:</span> <span class=\"token class-name\">TCP</span>\n    targetPort<span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span>\nselector<span class=\"token punctuation\">:</span>\n    io<span class=\"token punctuation\">.</span>kompose<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span>Values<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">.</span>app <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\nsessionAffinity<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ClientIP</span>\ntype<span class=\"token punctuation\">:</span> <span class=\"token class-name\">LoadBalancer</span>\nloadBalancerIP<span class=\"token punctuation\">:</span> <span class=\"token number\">35.223</span><span class=\"token number\">.27</span><span class=\"token number\">.28</span></code></pre></div>\n<p>GCP에서 서비스 하다보니 LBIP를 임의로 지정해주어서 서비스를 설정했다.<br>\n이 부분은 이후의 포스트에서 자세하게 설명한다.</p>\n</li>\n</ul>\n<br/>\n<br/>\n<ul>\n<li>\n<p>mysql-deployment.yaml</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">apiVersion<span class=\"token punctuation\">:</span> apps<span class=\"token operator\">/</span><span class=\"token class-name\">v1</span>\nkind<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Deployment</span>\nmetadata<span class=\"token punctuation\">:</span>\nannotations<span class=\"token punctuation\">:</span>\n    kompose<span class=\"token punctuation\">.</span>cmd<span class=\"token punctuation\">:</span> kompose convert\n    kompose<span class=\"token punctuation\">.</span>version<span class=\"token punctuation\">:</span> <span class=\"token number\">1.21</span><span class=\"token number\">.0</span> <span class=\"token punctuation\">(</span>992df58d8<span class=\"token punctuation\">)</span>\ncreationTimestamp<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\nlabels<span class=\"token punctuation\">:</span>\n    io<span class=\"token punctuation\">.</span>kompose<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">:</span> <span class=\"token class-name\">mysql</span>\nname<span class=\"token punctuation\">:</span> <span class=\"token class-name\">mysql</span>\nspec<span class=\"token punctuation\">:</span>\nreplicas<span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\nselector<span class=\"token punctuation\">:</span>\n    matchLabels<span class=\"token punctuation\">:</span>\n    io<span class=\"token punctuation\">.</span>kompose<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">:</span> <span class=\"token class-name\">mysql</span>\nstrategy<span class=\"token punctuation\">:</span>\n    type<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Recreate</span>\ntemplate<span class=\"token punctuation\">:</span>\n    metadata<span class=\"token punctuation\">:</span>\n    annotations<span class=\"token punctuation\">:</span>\n        kompose<span class=\"token punctuation\">.</span>cmd<span class=\"token punctuation\">:</span> kompose convert\n        kompose<span class=\"token punctuation\">.</span>version<span class=\"token punctuation\">:</span> <span class=\"token number\">1.21</span><span class=\"token number\">.0</span> <span class=\"token punctuation\">(</span>992df58d8<span class=\"token punctuation\">)</span>\n    creationTimestamp<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\n    labels<span class=\"token punctuation\">:</span>\n        io<span class=\"token punctuation\">.</span>kompose<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">:</span> <span class=\"token class-name\">mysql</span>\n    spec<span class=\"token punctuation\">:</span>\n    containers<span class=\"token punctuation\">:</span>\n    <span class=\"token operator\">-</span> env<span class=\"token punctuation\">:</span>\n        <span class=\"token operator\">-</span> name<span class=\"token punctuation\">:</span> <span class=\"token class-name\">MYSQL_ROOT_PASSWORD</span>\n        <span class=\"token keyword\">value</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">ec95c258266b8e985848cae688effa2b</span>\n        image<span class=\"token punctuation\">:</span> mysql<span class=\"token punctuation\">:</span><span class=\"token number\">5.5</span>\n        imagePullPolicy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">IfNotPresent</span>\n        name<span class=\"token punctuation\">:</span> <span class=\"token class-name\">mysql</span>\n        resources<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n        volumeMounts<span class=\"token punctuation\">:</span>\n        <span class=\"token operator\">-</span> mountPath<span class=\"token punctuation\">:</span> <span class=\"token operator\">/</span><span class=\"token keyword\">var</span><span class=\"token operator\">/</span>lib<span class=\"token operator\">/</span><span class=\"token class-name\">mysql</span>\n        name<span class=\"token punctuation\">:</span> mysql<span class=\"token operator\">-</span><span class=\"token class-name\">vol</span>\n    restartPolicy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Always</span>\n    serviceAccountName<span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    volumes<span class=\"token punctuation\">:</span>\n    <span class=\"token operator\">-</span> name<span class=\"token punctuation\">:</span> mysql<span class=\"token operator\">-</span><span class=\"token class-name\">vol</span>\n        persistentVolumeClaim<span class=\"token punctuation\">:</span>\n        claimName<span class=\"token punctuation\">:</span> mysql<span class=\"token operator\">-</span><span class=\"token class-name\">pvc</span>\nstatus<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n<br/>\n<br/>\n<ul>\n<li>\n<p>mysql-service.yaml</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">apiVersion<span class=\"token punctuation\">:</span> <span class=\"token class-name\">v1</span>\nkind<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Service</span>\nmetadata<span class=\"token punctuation\">:</span>\nannotations<span class=\"token punctuation\">:</span>\n    kompose<span class=\"token punctuation\">.</span>cmd<span class=\"token punctuation\">:</span> kompose convert\n    kompose<span class=\"token punctuation\">.</span>version<span class=\"token punctuation\">:</span> <span class=\"token number\">1.21</span><span class=\"token number\">.0</span> <span class=\"token punctuation\">(</span>992df58d8<span class=\"token punctuation\">)</span>\ncreationTimestamp<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\nlabels<span class=\"token punctuation\">:</span>\n    io<span class=\"token punctuation\">.</span>kompose<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">:</span> <span class=\"token class-name\">mysql</span>\nname<span class=\"token punctuation\">:</span> <span class=\"token class-name\">mysql</span>\nspec<span class=\"token punctuation\">:</span>\nports<span class=\"token punctuation\">:</span>\n<span class=\"token operator\">-</span> name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"3306\"</span>\n    port<span class=\"token punctuation\">:</span> <span class=\"token number\">3306</span>\n    targetPort<span class=\"token punctuation\">:</span> <span class=\"token number\">3306</span>\nselector<span class=\"token punctuation\">:</span>\n    io<span class=\"token punctuation\">.</span>kompose<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">:</span> mysql</code></pre></div>\n</li>\n</ul>\n<br/>\n<br/>\n<ul>\n<li>\n<p>mysql-pvc.yaml</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">apiVersion<span class=\"token punctuation\">:</span> <span class=\"token class-name\">v1</span>\nkind<span class=\"token punctuation\">:</span> <span class=\"token class-name\">PersistentVolumeClaim</span>\nmetadata<span class=\"token punctuation\">:</span>\ncreationTimestamp<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\nlabels<span class=\"token punctuation\">:</span>\n    io<span class=\"token punctuation\">.</span>kompose<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">:</span> <span class=\"token class-name\">mysql</span>\nname<span class=\"token punctuation\">:</span> mysql<span class=\"token operator\">-</span>pvc\n<span class=\"token keyword\">namespace</span><span class=\"token punctuation\">:</span> cd<span class=\"token operator\">-</span><span class=\"token class-name\">test</span>\nspec<span class=\"token punctuation\">:</span>\naccessModes<span class=\"token punctuation\">:</span>\n<span class=\"token operator\">-</span> <span class=\"token class-name\">ReadWriteMany</span>\nstorageClassName<span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\nvolumeName<span class=\"token punctuation\">:</span> <span class=\"token class-name\">dbserver</span>\nresources<span class=\"token punctuation\">:</span>\n    requests<span class=\"token punctuation\">:</span>\n    storage<span class=\"token punctuation\">:</span> 5Gi\nstatus<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>GCP의 FILE STORE를 사용해서 PVC를 만들었다<br>\n이 부분에서는 다음 포스트에서 자세하게 설명되어있다.</p>\n</li>\n</ul>\n<br/>\n<br/>\n<ul>\n<li>\n<p>mysql-pv-nfscreate.yaml</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">apiVersion<span class=\"token punctuation\">:</span> <span class=\"token class-name\">v1</span>\nkind<span class=\"token punctuation\">:</span> <span class=\"token class-name\">PersistentVolume</span>\nmetadata<span class=\"token punctuation\">:</span>\nname<span class=\"token punctuation\">:</span> dbserver\n<span class=\"token keyword\">namespace</span><span class=\"token punctuation\">:</span> cd<span class=\"token operator\">-</span><span class=\"token class-name\">test</span>\nspec<span class=\"token punctuation\">:</span>\ncapacity<span class=\"token punctuation\">:</span>\n    storage<span class=\"token punctuation\">:</span> 10Gi\nvolumeMode<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Filesystem</span>\naccessModes<span class=\"token punctuation\">:</span>\n    <span class=\"token operator\">-</span> <span class=\"token class-name\">ReadWriteMany</span>\npersistentVolumeReclaimPolicy<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Retain</span>\nstorageClassName<span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\nnfs<span class=\"token punctuation\">:</span>\n    path<span class=\"token punctuation\">:</span> <span class=\"token operator\">/</span><span class=\"token class-name\">nfs_share</span>\n    server<span class=\"token punctuation\">:</span> <span class=\"token number\">10.254</span><span class=\"token number\">.194</span><span class=\"token number\">.122</span></code></pre></div>\n<p>PV의 생성 또한 다음포스트에서 다룬다.</p>\n</li>\n</ul>\n<br/>\n<br/>\n<ul>\n<li>\n<p>namespace.yaml</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">kind<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Namespace</span>\napiVersion<span class=\"token punctuation\">:</span> <span class=\"token class-name\">v1</span>\nmetadata<span class=\"token punctuation\">:</span>\nannotations<span class=\"token punctuation\">:</span>\n    field<span class=\"token punctuation\">.</span>cattle<span class=\"token punctuation\">.</span>io<span class=\"token operator\">/</span>projectId<span class=\"token punctuation\">:</span> c<span class=\"token operator\">-</span>dcn6h<span class=\"token punctuation\">:</span>p<span class=\"token operator\">-</span>8scft\nname<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span>Values<span class=\"token punctuation\">.</span><span class=\"token keyword\">namespace</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\nlabels<span class=\"token punctuation\">:</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span>Values<span class=\"token punctuation\">.</span><span class=\"token keyword\">namespace</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    field<span class=\"token punctuation\">.</span>cattle<span class=\"token punctuation\">.</span>io<span class=\"token operator\">/</span>projectId<span class=\"token punctuation\">:</span> p<span class=\"token operator\">-</span>8scft</code></pre></div>\n<p>간단한 앱 배포를 위한 네임스페이스를 생성하는 매니페스트 파일이다.</p>\n</li>\n</ul>\n<br/>\n<hr>\n<p>결론적으로 GITHUB에 헬름 저장소를 넣어둔 뒤 해당 저장소의 값이 바뀌면<br>\nArgo-CD 가 SYNC를 맞춰주면서 배포를 하는 프로세스입니다..</p>\n<p><img src=\"https://user-images.githubusercontent.com/69498804/98903444-f376b880-24fa-11eb-9042-094db9247577.png\" alt=\"스크린샷, 2020-11-12 15-22-57\"></p>\n<ul>\n<li><a href=\"https://github.com/nasa1515/cccr-dvwa-helm\">저장소 링크</a></li>\n</ul>\n<br/>\n<hr>\n<h3 id=\"마치며\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EC%B9%98%EB%A9%B0\" aria-label=\"마치며 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마치며…</h3>\n<p>실제로 매니페스트를 일일히 수정하고 생성하면 k8s에 대한 개념들을 다시 잡은 것 같습니다.<br>\n이번 포스트에서 드디어 간단한 파이프라인 자동화를 마칠 수 있었고 보람찬 포스트였습니다.<br>\n약간의 아쉬움이 드는 것은 GCP가 아닌 AWS, AZURE로 했으면 어땠을까 하는 아쉬움이 남습니다.<br>\n생각보다 GCP에서 지원해주는 기능들이 원만하게 사용되지 않는 경우가 많아서…</p>\n<hr>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#-dvwa-msa-%EC%83%9D%EC%84%B1\">✔ DVWA MSA 생성</a></p>\n<ul>\n<li><a href=\"#-%EB%A9%94%EB%8B%88%ED%8E%98%EC%8A%A4%ED%8A%B8-%ED%95%98%EB%82%98%EC%94%A9-%EB%82%B4%EC%9A%A9%EC%9D%84-%EC%82%B4%ED%8E%B4%EB%B3%B4%EC%9E%90\">✌ 메니페스트 하나씩 내용을 살펴보자.</a></li>\n<li><a href=\"#%EB%A7%88%EC%B9%98%EB%A9%B0\">마치며…</a></li>\n</ul>\n</li>\n</ul>\n</div>","frontmatter":{"date":"August 07, 2021","title":"[DEVOPS] - 보안 취약점 검사를 위한 Dvmn 앱 자동 배포하기","categories":"DevOps","author":"nasa1515","emoji":"🤦‍♂️"},"fields":{"slug":"/devops-cicd2/"}},"prev":{"id":"b022c64e-b03d-5890-807a-f79d479433c2","html":"<p>머리말  </p>\n<p>이전 포스트에서 간단하게 이미지를 빌드한 뒤 ArgoCD와 SYNC를 맞춰 배포를 자동화한 파이프 라인을 완성했습니다.<br>\n이번 포스트에서는 Jenkins에서 해당 이미지를 빌드하는 부분에 대해서 포스트 했습니다.</p>\n<hr>\n<ul>\n<li>\n<p>사용 할 툴을 다음과 같습니다.  </p>\n<ul>\n<li>Jenkins</li>\n<li>maven</li>\n<li>github</li>\n<li>ArgoCD</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h2 id=\"-전체-jenkins-파이프라인\" style=\"position:relative;\"><a href=\"#-%EC%A0%84%EC%B2%B4-jenkins-%ED%8C%8C%EC%9D%B4%ED%94%84%EB%9D%BC%EC%9D%B8\" aria-label=\" 전체 jenkins 파이프라인 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>✔ 전체 Jenkins 파이프라인</h2>\n<ul>\n<li>\n<p>파이프라인 스크립트</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token function\">properties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n<span class=\"token function\">parameters</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    <span class=\"token keyword\">string</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">name</span><span class=\"token punctuation\">:</span> 'sonar<span class=\"token punctuation\">.</span>projectKey'<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">defaultValue</span><span class=\"token punctuation\">:</span> 'com<span class=\"token punctuation\">.</span>appsecco<span class=\"token punctuation\">:</span>dvja'<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">string</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">name</span><span class=\"token punctuation\">:</span> 'sonar<span class=\"token punctuation\">.</span>host<span class=\"token punctuation\">.</span>url'<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">defaultValue</span><span class=\"token punctuation\">:</span> 'http<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span><span class=\"token number\">34.64</span><span class=\"token number\">.237</span><span class=\"token number\">.112</span><span class=\"token punctuation\">:</span><span class=\"token number\">9000</span>'<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">string</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">name</span><span class=\"token punctuation\">:</span> 'sonar<span class=\"token punctuation\">.</span>login'<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">defaultValue</span><span class=\"token punctuation\">:</span> '608cacd6bb83c50712ebb34c4cba377c841cdebb'<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">string</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">name</span><span class=\"token punctuation\">:</span> 'ARGOCD_DOMAIN'<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">defaultValue</span><span class=\"token punctuation\">:</span> '<span class=\"token number\">34.67</span><span class=\"token number\">.162</span><span class=\"token number\">.44</span><span class=\"token punctuation\">:</span><span class=\"token number\">30357</span>'<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">string</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">name</span><span class=\"token punctuation\">:</span> 'ARGOCD_PW'<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">defaultValue</span><span class=\"token punctuation\">:</span> 'argo<span class=\"token operator\">-</span>cd<span class=\"token operator\">-</span>argocd<span class=\"token operator\">-</span>server<span class=\"token operator\">-</span>6d5f98cf57<span class=\"token operator\">-</span>wmf46'<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">string</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">name</span><span class=\"token punctuation\">:</span> 'ARGOCD_APP_NAME'<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">defaultValue</span><span class=\"token punctuation\">:</span> 'test'<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">string</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">name</span><span class=\"token punctuation\">:</span> 'tag_num'<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">defaultValue</span><span class=\"token punctuation\">:</span> ''<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> \n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\npipeline <span class=\"token punctuation\">{</span>\n    environment <span class=\"token punctuation\">{</span>\n        slack_channel <span class=\"token operator\">=</span> '#studying'\n        REGISTRY <span class=\"token operator\">=</span> 'cccr<span class=\"token operator\">/</span>jisun'\n        REGISTRY_IP <span class=\"token operator\">=</span> '<span class=\"token number\">34.64</span><span class=\"token number\">.237</span><span class=\"token number\">.112</span>'\n        REGISTRYCREDENTIAL <span class=\"token operator\">=</span> 'harbor' \n        DOCKER_IMAGE <span class=\"token operator\">=</span> ''\n        TAG_NUM <span class=\"token operator\">=</span> ''\n    <span class=\"token punctuation\">}</span>\n    agent <span class=\"token return-type class-name\">any</span>\n    tools <span class=\"token punctuation\">{</span> \n        maven 'mvn' \n    <span class=\"token punctuation\">}</span>\n    stages <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">stage</span><span class=\"token punctuation\">(</span>'Git clone'<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            steps <span class=\"token punctuation\">{</span>\n                git 'https<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>github<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>JisunParkRea<span class=\"token operator\">/</span>cccr<span class=\"token operator\">-</span>dvwa<span class=\"token punctuation\">.</span>git'\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token function\">stage</span><span class=\"token punctuation\">(</span>'Build Test'<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            steps <span class=\"token punctuation\">{</span>\n                sh 'mvn clean package <span class=\"token operator\">-</span>Dcheckstyle<span class=\"token punctuation\">.</span>skip <span class=\"token operator\">-</span>Dspotbugs<span class=\"token punctuation\">.</span>skip <span class=\"token operator\">-</span>Dpmd<span class=\"token punctuation\">.</span>skip'\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        stage <span class=\"token punctuation\">(</span>'Dependency<span class=\"token operator\">-</span>Check Analysis'<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            steps <span class=\"token punctuation\">{</span>\n                sh '<span class=\"token operator\">/</span><span class=\"token keyword\">var</span><span class=\"token operator\">/</span>lib<span class=\"token operator\">/</span>jenkins<span class=\"token operator\">/</span>dependency<span class=\"token operator\">-</span>check<span class=\"token operator\">/</span>bin<span class=\"token operator\">/</span>dependency<span class=\"token operator\">-</span>check<span class=\"token punctuation\">.</span>sh <span class=\"token operator\">--</span>scan `pwd` <span class=\"token operator\">--</span>format XML <span class=\"token operator\">--</span><span class=\"token keyword\">out</span> <span class=\"token operator\">/</span><span class=\"token keyword\">var</span><span class=\"token operator\">/</span>lib<span class=\"token operator\">/</span>jenkins<span class=\"token operator\">/</span>workspace<span class=\"token operator\">/</span>ci<span class=\"token operator\">-</span>build<span class=\"token operator\">-</span>pipeline<span class=\"token operator\">/</span>dependency<span class=\"token operator\">-</span>check<span class=\"token operator\">-</span>report <span class=\"token operator\">--</span>prettyPrint'\n                \n                <span class=\"token class-name\">dependencyCheckPublisher</span> pattern<span class=\"token punctuation\">:</span> 'dependency<span class=\"token operator\">-</span>check<span class=\"token operator\">-</span>report<span class=\"token operator\">/</span>dependency<span class=\"token operator\">-</span>check<span class=\"token operator\">-</span>report<span class=\"token punctuation\">.</span>xml'\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token function\">stage</span><span class=\"token punctuation\">(</span>'Sonarqube <span class=\"token keyword\">and</span> Quality gate'<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            options <span class=\"token punctuation\">{</span>\n                timeout<span class=\"token return-type class-name\"><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">:</span> 5<span class=\"token punctuation\">,</span> unit<span class=\"token punctuation\">:</span> 'MINUTES'<span class=\"token punctuation\">)</span></span>\n                <span class=\"token function\">retry</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n            steps <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">withSonarQubeEnv</span><span class=\"token punctuation\">(</span>'SonarQube Server'<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    sh <span class=\"token string\">\"mvn sonar:sonar\"</span>\n                <span class=\"token punctuation\">}</span>\n                script <span class=\"token punctuation\">{</span>\n                    qualitygate <span class=\"token operator\">=</span> <span class=\"token function\">waitForQualityGate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>qualitygate<span class=\"token punctuation\">.</span>status <span class=\"token operator\">!=</span> <span class=\"token string\">\"OK\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        currentBuild<span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> <span class=\"token string\">\"FAILURE\"</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token function\">stage</span><span class=\"token punctuation\">(</span>'Docker image build'<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> \n            steps<span class=\"token punctuation\">{</span>\n                script <span class=\"token punctuation\">{</span>\n                    DOCKER_IMAGE <span class=\"token operator\">=</span> docker<span class=\"token punctuation\">.</span>build registry\n                \n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> \n        <span class=\"token function\">stage</span><span class=\"token punctuation\">(</span>'Docker image push to Harbor'<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            steps<span class=\"token punctuation\">{</span>\n                script <span class=\"token punctuation\">{</span>\n                    docker<span class=\"token punctuation\">.</span><span class=\"token function\">withRegistry</span><span class=\"token punctuation\">(</span>'http<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>$REGISTRY_IP'<span class=\"token punctuation\">,</span> REGISTRYCREDENTIAL<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        DOCKER_IMAGE<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>'$<span class=\"token punctuation\">{</span>BUILD_NUMBER<span class=\"token punctuation\">}</span>'<span class=\"token punctuation\">)</span>\n                        DOCKER_IMAGE<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"latest\"</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n                sh 'docker rmi $REGISTRY<span class=\"token punctuation\">:</span>latest'\n                sh 'docker rmi $REGISTRY_IP<span class=\"token operator\">/</span>$REGISTRY<span class=\"token punctuation\">:</span>$BUILD_NUMBER'\n                sh 'docker rmi $REGISTRY_IP<span class=\"token operator\">/</span>$REGISTRY<span class=\"token punctuation\">:</span>latest'\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token function\">stage</span><span class=\"token punctuation\">(</span>'Anchore analyse'<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n            steps <span class=\"token punctuation\">{</span>  \n                <span class=\"token function\">catchError</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">buildResult</span><span class=\"token punctuation\">:</span> 'SUCCESS'<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">stageResult</span><span class=\"token punctuation\">:</span> 'SUCCESS'<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\">writeFile</span> file<span class=\"token punctuation\">:</span> 'anchore_images'<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">text</span><span class=\"token punctuation\">:</span> '<span class=\"token number\">34.64</span><span class=\"token number\">.237</span><span class=\"token number\">.112</span><span class=\"token operator\">/</span>cccr<span class=\"token operator\">/</span>jisun'  \n                <span class=\"token class-name\">anchore</span> name<span class=\"token punctuation\">:</span> 'anchore_images'  \n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">stage</span><span class=\"token punctuation\">(</span>'Push Yaml'<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            steps <span class=\"token punctuation\">{</span>\n                script<span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token class-name\">git</span> url<span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://github.com/JisunParkRea/cccr-dvwa-helm\"</span><span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">branch</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"main\"</span><span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">credentialsId</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"github\"</span>\n                        sh <span class=\"token string\">\"rm -rf /var/lib/jenkins/workspace/${env.JOB_NAME}/helm-service/values.yaml\"</span>\n                        sh <span class=\"token string\">\"\"</span>\"\n                        cd helm<span class=\"token operator\">-</span>service\n                        <span class=\"token preprocessor property\">#!/bin/bash</span>\n                        cat<span class=\"token operator\">></span>values<span class=\"token punctuation\">.</span>yaml<span class=\"token operator\">&lt;&lt;</span><span class=\"token operator\">-</span>EOF\n<span class=\"token preprocessor property\"># Default values for ghost.</span>\n<span class=\"token preprocessor property\"># This is a YAML-formatted file.</span>\n<span class=\"token preprocessor property\"># Declare variables to be passed into your templates.</span>\n\nreplicaCount<span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n\nimage<span class=\"token punctuation\">:</span>\nrepository<span class=\"token punctuation\">:</span> jisunpark<span class=\"token operator\">/</span>cccr<span class=\"token operator\">-</span>dvwa<span class=\"token operator\">-</span>java<span class=\"token operator\">-</span><span class=\"token class-name\">web</span>\ntag<span class=\"token punctuation\">:</span> $<span class=\"token class-name\">BUILD_NUMBER</span>\npullPolicy<span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n\n\n<span class=\"token keyword\">value</span><span class=\"token punctuation\">:</span> ec95c258266b8e985848cae688effa2b\n\n<span class=\"token keyword\">namespace</span><span class=\"token punctuation\">:</span> cd<span class=\"token operator\">-</span><span class=\"token class-name\">test</span>\n\nname<span class=\"token punctuation\">:</span> \napp<span class=\"token punctuation\">:</span> app\nEOF<span class=\"token string\">\"\"</span>\"\n                        sh <span class=\"token string\">\"cat /var/lib/jenkins/workspace/${env.JOB_NAME}/helm-service/values.yaml\"</span>\n                        <span class=\"token function\">withCredentials</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token function\">usernamePassword</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">credentialsId</span><span class=\"token punctuation\">:</span> 'github'<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">passwordVariable</span><span class=\"token punctuation\">:</span> 'GIT_PASSWORD'<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">usernameVariable</span><span class=\"token punctuation\">:</span> 'GIT_USERNAME'<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                            sh <span class=\"token string\">\"\"</span>\"\n                            git <span class=\"token keyword\">add</span> <span class=\"token operator\">--</span>all <span class=\"token punctuation\">.</span>\n                            git commit <span class=\"token operator\">-</span>m <span class=\"token string\">\"Deploy ${env.JOB_NAME} ${env.BUILD_NUMBER}\"</span>\n                            git <span class=\"token class-name\">push</span> https<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>$<span class=\"token punctuation\">{</span>GIT_USERNAME<span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span>$<span class=\"token punctuation\">{</span>GIT_PASSWORD<span class=\"token punctuation\">}</span>@github<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>JisunParkRea<span class=\"token operator\">/</span>cccr<span class=\"token operator\">-</span>dvwa<span class=\"token operator\">-</span>helm\n                            <span class=\"token string\">\"\"</span>\"\n                        <span class=\"token punctuation\">}</span>                      \n                        env<span class=\"token punctuation\">.</span>pushYamlResult<span class=\"token operator\">=</span><span class=\"token boolean\">true</span>\n                    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n                        echo 'Remove Deploy Files'\n                        <span class=\"token function\">withCredentials</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token function\">usernamePassword</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">credentialsId</span><span class=\"token punctuation\">:</span> 'github'<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">passwordVariable</span><span class=\"token punctuation\">:</span> 'GIT_PASSWORD'<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">usernameVariable</span><span class=\"token punctuation\">:</span> 'GIT_USERNAME'<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                            sh <span class=\"token string\">\"\"</span>\"\n                            git reset <span class=\"token operator\">--</span>hard HEAD<span class=\"token operator\">^</span>\n                            git push <span class=\"token operator\">--</span><span class=\"token class-name\">force</span> https<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>$<span class=\"token punctuation\">{</span>GIT_USERNAME<span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span>$<span class=\"token punctuation\">{</span>GIT_PASSWORD<span class=\"token punctuation\">}</span>@github<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>JisunParkRea<span class=\"token operator\">/</span>cccr<span class=\"token operator\">-</span>dvwa<span class=\"token operator\">-</span>helm\n                            <span class=\"token string\">\"\"</span>\"\n                        <span class=\"token punctuation\">}</span>\n                        env<span class=\"token punctuation\">.</span>pushYamlResult<span class=\"token operator\">=</span><span class=\"token boolean\">false</span>\n                        currentBuild<span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> 'FAILURE'\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">stage</span><span class=\"token punctuation\">(</span>'Argo Deploy'<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            steps <span class=\"token punctuation\">{</span>\n                script<span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token function\">withEnv</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"PATH=/usr/local/bin:$PATH\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                            sh<span class=\"token string\">\"\"</span>\"\n<span class=\"token preprocessor property\">#!/bin/bash</span>\nexpect <span class=\"token operator\">&lt;&lt;</span> EOF\nspawn argocd login <span class=\"token operator\">--</span>grpc<span class=\"token operator\">-</span>web $ARGOCD_DOMAIN\n\nexpect <span class=\"token string\">\"WARNING: server certificate had error: x509: cannot validate certificate for 34.67.162.44 because it doesn't contain any IP SANs. Proceed insecurely (y/n)?\"</span>\nsend <span class=\"token string\">\"y\\r\"</span><span class=\"token punctuation\">;</span>\n\nexpect <span class=\"token string\">\"Username:\"</span>\nsend <span class=\"token string\">\"admin\\r\"</span><span class=\"token punctuation\">;</span>    \n\nexpect <span class=\"token string\">\"Password:\"</span>\nsend <span class=\"token string\">\"$ARGOCD_PW\\r\"</span><span class=\"token punctuation\">;</span>    \n                                \nexpect eof\nEOF\n                                argocd app <span class=\"token keyword\">get</span> $ARGOCD_APP_NAME\n                                argocd app sync $ARGOCD_APP_NAME\n                            <span class=\"token string\">\"\"</span>\"\n                        <span class=\"token punctuation\">}</span>\n                    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n                        currentBuild<span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> 'FAILURE'\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n    <span class=\"token punctuation\">}</span>\n    post <span class=\"token punctuation\">{</span> \n    success <span class=\"token punctuation\">{</span> \n        slackSend <span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">channel</span><span class=\"token punctuation\">:</span> SLACK_CHANNEL<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">color</span><span class=\"token punctuation\">:</span> 'good'<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">message</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"SUCCESSFUL: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' (${env.BUILD_URL})\"</span><span class=\"token punctuation\">)</span> \n    <span class=\"token punctuation\">}</span>\n    failure <span class=\"token punctuation\">{</span>\n        slackSend <span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">channel</span><span class=\"token punctuation\">:</span> SLACK_CHANNEL<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">color</span><span class=\"token punctuation\">:</span> 'bad'<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">message</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"FAILURE: '${env.JOB_NAME} [${env.BUILD_NUMBER}]' (${env.BUILD_URL})\"</span><span class=\"token punctuation\">)</span>\t\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n<br/>\n<h3 id=\"파이프라인의-프로세스\" style=\"position:relative;\"><a href=\"#%ED%8C%8C%EC%9D%B4%ED%94%84%EB%9D%BC%EC%9D%B8%EC%9D%98-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4\" aria-label=\"파이프라인의 프로세스 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>파이프라인의 프로세스</h3>\n<ol>\n<li>소스코드를 Clone 해온 뒤 Build 테스트  </li>\n<li>Dependency-Check Analysis 로 코드 정적분석  </li>\n<li>Sonarqube and Quality gate 정적분석  </li>\n<li>위의 검사에서 에러가 없으면 Docker image build  </li>\n<li>빌드한 도커이미지를 HARBOR 저장소에 PUSH  </li>\n<li>HARBOR에 저장된 이미지의 에러 검사  </li>\n<li>새로운 빌드 넘버로 메니페스트 수정 후 GITOPS 저장소로 푸시  </li>\n<li>ArgoCD로 Sync 요청</li>\n</ol>\n<br/>\n<hr>\n<h3 id=\"dvwa-빌드-소스-저장소\" style=\"position:relative;\"><a href=\"#dvwa-%EB%B9%8C%EB%93%9C-%EC%86%8C%EC%8A%A4-%EC%A0%80%EC%9E%A5%EC%86%8C\" aria-label=\"dvwa 빌드 소스 저장소 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DVWA! 빌드 소스 저장소!</h3>\n<br/>\n<ul>\n<li>\n<p>DVWA 빌드소스 저장소는 아래와 같이 구성했습니다.<br>\n<a href=\"https://github.com/nasa1515/cccr-dvwa\">저장소링크</a> </p>\n<p><img src=\"https://user-images.githubusercontent.com/69498804/98904414-e3f86f00-24fc-11eb-8576-c3088ed9babd.png\" alt=\"스크린샷, 2020-11-12 15-36-51\"></p>\n<p>Jenkins 에서는 해당 저장소를 Clone 후 이미지를 빌드 할 예정입니다.</p>\n</li>\n</ul>\n<br/>\n<hr>\n<h3 id=\"maven-빌드-전-사전작업\" style=\"position:relative;\"><a href=\"#maven-%EB%B9%8C%EB%93%9C-%EC%A0%84-%EC%82%AC%EC%A0%84%EC%9E%91%EC%97%85\" aria-label=\"maven 빌드 전 사전작업 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MAVEN 빌드 전 사전작업</h3>\n<br/>\n<p>아래 두 설정을 모두 만족해야 정상적인 빌드가 됩니다.</p>\n<ol>\n<li>\n<p>Jenkins에서 JDK 설정  </p>\n<p><img src=\"https://user-images.githubusercontent.com/69498804/102846942-b506de80-4454-11eb-8bb9-90cd582d3447.PNG\" alt=\"캡처\"></p>\n</li>\n</ol>\n<br/>\n<ol start=\"2\">\n<li>\n<p>Jenkins에서 MAVEN 설정</p>\n<p><img src=\"https://user-images.githubusercontent.com/69498804/102846986-cc45cc00-4454-11eb-89e4-28471be55ba7.PNG\" alt=\"캡처2\"></p>\n</li>\n</ol>\n<br/>\n<hr>\n<h3 id=\"빌드-파이프라인-스크립트\" style=\"position:relative;\"><a href=\"#%EB%B9%8C%EB%93%9C-%ED%8C%8C%EC%9D%B4%ED%94%84%EB%9D%BC%EC%9D%B8-%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8\" aria-label=\"빌드 파이프라인 스크립트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>빌드 파이프라인 스크립트</h3>\n<br/>\n<ul>\n<li>\n<p>전체적인 파이프라인 스크립트에서 MAVEN 빌드 부분만 떼어냈습니다.  </p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\">pipeline <span class=\"token punctuation\">{</span>\n    agent <span class=\"token return-type class-name\">any</span>\n    tools <span class=\"token punctuation\">{</span> \n        maven 'mvn' \n    <span class=\"token punctuation\">}</span>\n    stages <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">stage</span><span class=\"token punctuation\">(</span>'Git clone'<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            steps <span class=\"token punctuation\">{</span>\n                git 'https<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>github<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>JisunParkRea<span class=\"token operator\">/</span>cccr<span class=\"token operator\">-</span>dvwa<span class=\"token punctuation\">.</span>git'\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token function\">stage</span><span class=\"token punctuation\">(</span>'Build Test'<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            steps <span class=\"token punctuation\">{</span>\n               sh 'mvn clean package <span class=\"token operator\">-</span>Dcheckstyle<span class=\"token punctuation\">.</span>skip <span class=\"token operator\">-</span>Dspotbugs<span class=\"token punctuation\">.</span>skip <span class=\"token operator\">-</span>Dpmd<span class=\"token punctuation\">.</span>skip'\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n<br/>\n<ul>\n<li>스크립트에 대한 설명없이도 아마 대부분은 이해가 될 것입니다.<br>\n간단하게 설명하자면 Agent any로 jdk, mvn들의 툴을 선언해준 뒤<br>\n빌드 소스의 저장소를 clone 한 뒤 해당 소스들을 MVN으로 빌드하는 간단한 구문입니다<br>\n문법이 궁금하신분들은 <a href=\"https://jojoldu.tistory.com/355\">참고링크</a>를 읽어보시면 빠르게 이해 될 것입니다.<br>\n다음 포스트 부터는 전체적인 정적분석 툴의 스크립트에 대해서 간단하게 설명하겠습니다.</li>\n</ul>\n<br/>\n<hr>\n<h2 id=\"마치며\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EC%B9%98%EB%A9%B0\" aria-label=\"마치며 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마치며…</h2>\n<p>Jenkins를 만져본게 이번이 처음이었습니다.<br>\n문법부터 하나씩 차근차근 배워가며 하다보니 오히려 이 부분에서 시간이 많이 낭비된 것 같았습니다.<br>\n그렇지만 초반에 계획했던 프로젝트의 성격과 점점 맞아 떨어져가고 있다는 것에 너무 기쁩니다.  </p>\n<hr>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#-%EC%A0%84%EC%B2%B4-jenkins-%ED%8C%8C%EC%9D%B4%ED%94%84%EB%9D%BC%EC%9D%B8\">✔ 전체 Jenkins 파이프라인</a></p>\n<ul>\n<li><a href=\"#%ED%8C%8C%EC%9D%B4%ED%94%84%EB%9D%BC%EC%9D%B8%EC%9D%98-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4\">파이프라인의 프로세스</a></li>\n<li><a href=\"#dvwa-%EB%B9%8C%EB%93%9C-%EC%86%8C%EC%8A%A4-%EC%A0%80%EC%9E%A5%EC%86%8C\">DVWA! 빌드 소스 저장소!</a></li>\n<li><a href=\"#maven-%EB%B9%8C%EB%93%9C-%EC%A0%84-%EC%82%AC%EC%A0%84%EC%9E%91%EC%97%85\">MAVEN 빌드 전 사전작업</a></li>\n<li><a href=\"#%EB%B9%8C%EB%93%9C-%ED%8C%8C%EC%9D%B4%ED%94%84%EB%9D%BC%EC%9D%B8-%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8\">빌드 파이프라인 스크립트</a></li>\n</ul>\n</li>\n<li><a href=\"#%EB%A7%88%EC%B9%98%EB%A9%B0\">마치며…</a></li>\n</ul>\n</div>","frontmatter":{"date":"August 08, 2021","title":"[DEVOPS] - Jenkins로 Dvmn 앱 이미지 자동 빌드 및 푸시하기","categories":"DevOps","author":"nasa1515","emoji":"🤦‍♂️"},"fields":{"slug":"/devops-jenkinspush/"}},"site":{"siteMetadata":{"siteUrl":"https://nasa1515.com","comments":{"utterances":{"repo":"nasa1515/nasablog"}}}}},"pageContext":{"slug":"/devops-gcpfilestore/","nextSlug":"/devops-cicd2/","prevSlug":"/devops-jenkinspush/"}},"staticQueryHashes":["1073350324","2938748437"]}